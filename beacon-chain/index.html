

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Beacon Chain &mdash; The Beacon Chain 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Hash Tree" href="../hash-tree/" />
    <link rel="prev" title="K Semantics of Eth2.0 Beacon Chain" href="../README/" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../" class="icon icon-home"> The Beacon Chain
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README/">K Semantics of Eth2.0 Beacon Chain</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Beacon Chain</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#integer-squareroot"><code class="docutils literal notranslate"><span class="pre">integer_squareroot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#xor"><code class="docutils literal notranslate"><span class="pre">xor</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-active-validator"><code class="docutils literal notranslate"><span class="pre">is_active_validator</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-slashable-validator"><code class="docutils literal notranslate"><span class="pre">is_slashable_validator</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-slashable-attestation-data"><code class="docutils literal notranslate"><span class="pre">is_slashable_attestation_data</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-valid-indexed-attestation"><code class="docutils literal notranslate"><span class="pre">is_valid_indexed_attestation</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-valid-merkle-branch"><code class="docutils literal notranslate"><span class="pre">is_valid_merkle_branch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-shuffled-index"><code class="docutils literal notranslate"><span class="pre">compute_shuffled_index</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-proposer-index"><code class="docutils literal notranslate"><span class="pre">compute_proposer_index</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-committee"><code class="docutils literal notranslate"><span class="pre">compute_committee</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-epoch-at-slot"><code class="docutils literal notranslate"><span class="pre">compute_epoch_at_slot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-start-slot-at-epoch"><code class="docutils literal notranslate"><span class="pre">compute_start_slot_at_epoch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-activation-exit-epoch"><code class="docutils literal notranslate"><span class="pre">compute_activation_exit_epoch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-domain"><code class="docutils literal notranslate"><span class="pre">compute_domain</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-current-epoch"><code class="docutils literal notranslate"><span class="pre">get_current_epoch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-previous-epoch"><code class="docutils literal notranslate"><span class="pre">get_previous_epoch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-block-root"><code class="docutils literal notranslate"><span class="pre">get_block_root</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-block-root-at-slot"><code class="docutils literal notranslate"><span class="pre">get_block_root_at_slot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-randao-mix"><code class="docutils literal notranslate"><span class="pre">get_randao_mix</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-active-validator-indices"><code class="docutils literal notranslate"><span class="pre">get_active_validator_indices</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-validator-churn-limit"><code class="docutils literal notranslate"><span class="pre">get_validator_churn_limit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-seed"><code class="docutils literal notranslate"><span class="pre">get_seed</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-committee-count-at-slot"><code class="docutils literal notranslate"><span class="pre">get_committee_count_at_slot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-beacon-proposer-index"><code class="docutils literal notranslate"><span class="pre">get_beacon_proposer_index</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-total-balance"><code class="docutils literal notranslate"><span class="pre">get_total_balance</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-total-active-balance"><code class="docutils literal notranslate"><span class="pre">get_total_active_balance</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-domain"><code class="docutils literal notranslate"><span class="pre">get_domain</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-indexed-attestation"><code class="docutils literal notranslate"><span class="pre">get_indexed_attestation</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-attesting-indices"><code class="docutils literal notranslate"><span class="pre">get_attesting_indices</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#increase-balance"><code class="docutils literal notranslate"><span class="pre">increase_balance</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#decrease-balance"><code class="docutils literal notranslate"><span class="pre">decrease_balance</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#initiate-validator-exit"><code class="docutils literal notranslate"><span class="pre">initiate_validator_exit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#slash-validator"><code class="docutils literal notranslate"><span class="pre">slash_validator</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-valid-genesis-state"><code class="docutils literal notranslate"><span class="pre">is_valid_genesis_state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#state-transition"><code class="docutils literal notranslate"><span class="pre">state_transition</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-slots"><code class="docutils literal notranslate"><span class="pre">process_slots</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-slot"><code class="docutils literal notranslate"><span class="pre">process_slot</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-epoch"><code class="docutils literal notranslate"><span class="pre">process_epoch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-matching-source-attestations"><code class="docutils literal notranslate"><span class="pre">get_matching_source_attestations</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-matching-target-attestations"><code class="docutils literal notranslate"><span class="pre">get_matching_target_attestations</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-matching-head-attestations"><code class="docutils literal notranslate"><span class="pre">get_matching_head_attestations</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-unslashed-attesting-indices"><code class="docutils literal notranslate"><span class="pre">get_unslashed_attesting_indices</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-attesting-balance"><code class="docutils literal notranslate"><span class="pre">get_attesting_balance</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-justification-and-finalization"><code class="docutils literal notranslate"><span class="pre">process_justification_and_finalization</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-base-reward"><code class="docutils literal notranslate"><span class="pre">get_base_reward</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-attestation-deltas"><code class="docutils literal notranslate"><span class="pre">get_attestation_deltas</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-rewards-and-penalties"><code class="docutils literal notranslate"><span class="pre">process_rewards_and_penalties</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-registry-updates"><code class="docutils literal notranslate"><span class="pre">process_registry_updates</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-slashings"><code class="docutils literal notranslate"><span class="pre">process_slashings</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-final-updates"><code class="docutils literal notranslate"><span class="pre">process_final_updates</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-block"><code class="docutils literal notranslate"><span class="pre">process_block</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-block-header"><code class="docutils literal notranslate"><span class="pre">process_block_header</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-randao"><code class="docutils literal notranslate"><span class="pre">process_randao</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-operations"><code class="docutils literal notranslate"><span class="pre">process_operations</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-proposer-slashing"><code class="docutils literal notranslate"><span class="pre">process_proposer_slashing</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-attester-slashing"><code class="docutils literal notranslate"><span class="pre">process_attester_slashing</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-attestation"><code class="docutils literal notranslate"><span class="pre">process_attestation</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-deposit"><code class="docutils literal notranslate"><span class="pre">process_deposit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-voluntary-exit"><code class="docutils literal notranslate"><span class="pre">process_voluntary_exit</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hash-tree/">Hash Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config/">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../constants-minimal/">Constants (Minimal)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../constants-mainnet/">Constants (Mainnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../types/">Types</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">The Beacon Chain</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../">Docs</a> &raquo;</li>
        
      <li>Beacon Chain</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/beacon-chain.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="beacon-chain">
<span id="beacon-chain"></span><h1>Beacon Chain<a class="headerlink" href="#beacon-chain" title="Permalink to this headline">¶</a></h1>
<p>Notes:</p>
<ul class="simple">
<li>bls_verify is not implemented (as discussed). Signature verification is not done.</li>
</ul>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="nv">requires</span><span class="w"> </span><span class="s">&quot;hash-tree.k&quot;</span><span class="w"></span>

<span class="nv">module</span><span class="w"> </span><span class="nv">BEACON</span><span class="err">-</span><span class="nv">CHAIN</span><span class="w"></span>
<span class="w">  </span><span class="nv">imports</span><span class="w"> </span><span class="nv">DOMAINS</span><span class="w"></span>
<span class="w">  </span><span class="nv">imports</span><span class="w"> </span><span class="nv">HASH</span><span class="err">-</span><span class="nv">TREE</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Hacks around pyk/json front-end limitations</span>
<span class="w">  </span><span class="c1">//====================================================</span>

<span class="w">  </span><span class="c1">//Workarounds to make kast happy. Cannot put a function with no-args in init &lt;k&gt;, with json input.</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;wrap_hash_tree_root&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BytesOrContainer</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">wrap_hash_tree_root</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;wrap_hash_tree_root_state&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">wrap_hash_tree_root_state</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;wrap_is_valid_genesis_state&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">wrap_is_valid_genesis_state</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">wrap_hash_tree_root</span><span class="p">(</span><span class="nv">OBJ</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">OBJ</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">wrap_hash_tree_root_state</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">hash_tree_root_state</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">wrap_is_valid_genesis_state</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">is_valid_genesis_state</span><span class="p">()</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w">  </span><span class="s">&quot;test_process_slots&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">   </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">test_process_slots</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">test_process_slots</span><span class="p">(</span><span class="nv">NrSlots</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_slots</span><span class="p">(</span><span class="nv">SLOT</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">NrSlots</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Initialization</span>
<span class="w">  </span><span class="c1">//====================================================</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;noop&quot;</span><span class="w">                    </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">noop</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;init&quot;</span><span class="w">                    </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">init</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nv">initZeroHashes</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">ZERO_BYTES32</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">32</span>

<span class="n">zerohashes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ZERO_BYTES32</span><span class="p">]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">zerohashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">zerohashes</span><span class="p">[</span><span class="n">layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">zerohashes</span><span class="p">[</span><span class="n">layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">initZeroHashes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"> </span><span class="c1">//max pre-computed zerohash is 64 - ehough for all cases</span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">zerohashes</span><span class="err">-</span><span class="nv">cache</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">defaultHash</span><span class="p">())</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">zerohashes</span><span class="err">-</span><span class="nv">cache</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">initZeroHashes</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">zerohashes</span><span class="err">-</span><span class="nv">cache</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">.Map</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">hashConcat</span><span class="p">(</span><span class="nv">zerohashes</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nv">zerohashes</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">...</span><span class="err">&lt;/</span><span class="nv">zerohashes</span><span class="err">-</span><span class="nv">cache</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">initZeroHashes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>


<span class="w">  </span><span class="c1">// Helper functions -- Math</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
<div class="section" id="integer-squareroot">
<span id="integer-squareroot"></span><h2><code class="docutils literal notranslate"><span class="pre">integer_squareroot</span></code><a class="headerlink" href="#integer-squareroot" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">integer_squareroot</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">uint64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the largest integer ``x`` such that ``x**2 &lt;= n``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">n</span> <span class="o">//</span> <span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">x</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;integer_squareroot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">integer_squareroot</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">integer_squareroot_aux</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">N</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">N</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;integer_squareroot_aux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">integer_squareroot_aux</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">X</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Y</span><span class="p">,</span><span class="w"> </span><span class="nv">Y</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">Y</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Y</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">Y</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">X</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">integer_squareroot_aux</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">X</span><span class="p">,</span><span class="w"> </span><span class="nv">Y</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">X</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">Y</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">X</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="xor">
<span id="xor"></span><h2><code class="docutils literal notranslate"><span class="pre">xor</span></code><a class="headerlink" href="#xor" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">bytes_1</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span> <span class="n">bytes_2</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bytes32</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the exclusive-or of two 32-byte strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Bytes32</span><span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bytes_1</span><span class="p">,</span> <span class="n">bytes_2</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bytes</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">xor</span><span class="p">(</span><span class="w"> </span><span class="nv">Bytes</span><span class="p">,</span><span class="w"> </span><span class="nv">Bytes</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">xor</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="w"> </span><span class="nv">B</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">chrChar</span><span class="p">(</span><span class="nv">ordChar</span><span class="p">(</span><span class="nv">substrString</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="nv">xorInt</span><span class="w"> </span><span class="nv">ordChar</span><span class="p">(</span><span class="nv">substrString</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">xor</span><span class="p">(</span><span class="nv">substrString</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">lengthString</span><span class="p">(</span><span class="nv">A</span><span class="p">)),</span><span class="w"> </span><span class="nv">substrString</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">lengthString</span><span class="p">(</span><span class="nv">B</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">lengthString</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">lengthString</span><span class="p">(</span><span class="nv">B</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">xor</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>


<span class="w">  </span><span class="c1">// Helper functions -- Predicates</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="is-active-validator">
<span id="is-active-validator"></span><h2><code class="docutils literal notranslate"><span class="pre">is_active_validator</span></code><a class="headerlink" href="#is-active-validator" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``validator`` is active.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">&lt;=</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="o">.</span><span class="n">exit_epoch</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_active_validator&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Validator</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="w"> </span><span class="nv">VAL</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">VAL.activationEpoch</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="is-slashable-validator">
<span id="is-slashable-validator"></span><h2><code class="docutils literal notranslate"><span class="pre">is_slashable_validator</span></code><a class="headerlink" href="#is-slashable-validator" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_slashable_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``validator`` is slashable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">validator</span><span class="o">.</span><span class="n">slashed</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">&lt;=</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="o">.</span><span class="n">withdrawable_epoch</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_slashable_validator&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Validator</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_slashable_validator</span><span class="p">(</span><span class="w"> </span><span class="nv">VAL</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">VAL.slashed</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">VAL.activationEpoch</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">VAL.withdrawableEpoch</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="is-slashable-attestation-data">
<span id="is-slashable-attestation-data"></span><h2><code class="docutils literal notranslate"><span class="pre">is_slashable_attestation_data</span></code><a class="headerlink" href="#is-slashable-attestation-data" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_slashable_attestation_data</span><span class="p">(</span><span class="n">data_1</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">,</span> <span class="n">data_2</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``data_1`` and ``data_2`` are slashable according to Casper FFG rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="c1"># Double vote</span>
        <span class="p">(</span><span class="n">data_1</span> <span class="o">!=</span> <span class="n">data_2</span> <span class="ow">and</span> <span class="n">data_1</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">data_2</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="ow">or</span>
        <span class="c1"># Surround vote</span>
        <span class="p">(</span><span class="n">data_1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">data_2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">and</span> <span class="n">data_2</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">data_1</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_slashable_attestation_data&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">AttestationData</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">AttestationData</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_slashable_attestation_data</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nv">#AttestationData</span><span class="p">(</span><span class="nv">S1</span><span class="p">,</span><span class="w"> </span><span class="nv">I1</span><span class="p">,</span><span class="w"> </span><span class="nv">H1</span><span class="p">,</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">S1EP</span><span class="p">,</span><span class="nv">S1H</span><span class="p">),</span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">T1EP</span><span class="p">,</span><span class="nv">T1H</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="nv">#AttestationData</span><span class="p">(</span><span class="nv">S2</span><span class="p">,</span><span class="w"> </span><span class="nv">I2</span><span class="p">,</span><span class="w"> </span><span class="nv">H2</span><span class="p">,</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">S2EP</span><span class="p">,</span><span class="nv">S2H</span><span class="p">),</span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">T2EP</span><span class="p">,</span><span class="nv">T2H</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Double vote</span>
<span class="w">      </span><span class="c1">//((H1 =/=K H2 orBool S1EP =/=K S2EP orBool S1H =/=K S2H orBool T1H =/=K T2H orBool CL1 =/=K CL2) andBool</span>
<span class="w">      </span><span class="c1">//  T1EP ==K T2EP) orBool</span>
<span class="w">      </span><span class="p">(</span><span class="nv">#AttestationData</span><span class="p">(</span><span class="nv">S1</span><span class="p">,</span><span class="w"> </span><span class="nv">I1</span><span class="p">,</span><span class="w"> </span><span class="nv">H1</span><span class="p">,</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">S1EP</span><span class="p">,</span><span class="nv">S1H</span><span class="p">),</span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">T1EP</span><span class="p">,</span><span class="nv">T1H</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">#AttestationData</span><span class="p">(</span><span class="nv">S2</span><span class="p">,</span><span class="w"> </span><span class="nv">I2</span><span class="p">,</span><span class="w"> </span><span class="nv">H2</span><span class="p">,</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">S2EP</span><span class="p">,</span><span class="nv">S2H</span><span class="p">),</span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">T2EP</span><span class="p">,</span><span class="nv">T2H</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">T1EP</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">T2EP</span><span class="p">)</span><span class="w"> </span><span class="nv">orBool</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Surround vote</span>
<span class="w">      </span><span class="p">(</span><span class="nv">S1EP</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">S2EP</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">T2EP</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">T1EP</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="is-valid-indexed-attestation">
<span id="is-valid-indexed-attestation"></span><h2><code class="docutils literal notranslate"><span class="pre">is_valid_indexed_attestation</span></code><a class="headerlink" href="#is-valid-indexed-attestation" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indexed_attestation</span><span class="p">:</span> <span class="n">IndexedAttestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``indexed_attestation`` has valid indices and signature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indexed_attestation</span><span class="o">.</span><span class="n">attesting_indices</span>

    <span class="c1"># Verify max number of indices</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Verify indices are sorted</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">indices</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Verify aggregate signature</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bls_verify</span><span class="p">(</span> 
        <span class="n">pubkey</span><span class="o">=</span><span class="n">bls_aggregate_pubkeys</span><span class="p">([</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pubkey</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]),</span> 
        <span class="n">message_hash</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">indexed_attestation</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> 
        <span class="n">signature</span><span class="o">=</span><span class="n">indexed_attestation</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_ATTESTER</span><span class="p">,</span> <span class="n">indexed_attestation</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_valid_indexed_attestation&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">IndexedAttestation</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_valid_indexed_attestation</span><span class="p">(</span><span class="nv">IAtt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">IAtt.attesting_indices</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MAX_VALIDATORS_PER_COMMITTEE</span><span class="w"></span>
<span class="w">    </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">IAtt.attesting_indices</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">sortIntList</span><span class="p">(</span><span class="nv">IAtt.attesting_indices</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">//we do not check for BLS signature</span>
</pre></div>
</div>
</div>
<div class="section" id="is-valid-merkle-branch">
<span id="is-valid-merkle-branch"></span><h2><code class="docutils literal notranslate"><span class="pre">is_valid_merkle_branch</span></code><a class="headerlink" href="#is-valid-merkle-branch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_valid_merkle_branch</span><span class="p">(</span><span class="n">leaf</span><span class="p">:</span> <span class="n">Hash</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Hash</span><span class="p">],</span> <span class="n">depth</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Hash</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ``leaf`` at ``index`` verifies against the Merkle ``root`` and ``branch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">leaf</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">branch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">branch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="n">root</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_valid_merkle_branch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BytesList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_valid_merkle_branch</span><span class="p">(</span><span class="nv">Leaf</span><span class="p">,</span><span class="w"> </span><span class="nv">Branch</span><span class="p">,</span><span class="w"> </span><span class="nv">Depth</span><span class="p">,</span><span class="w"> </span><span class="nv">Index</span><span class="p">,</span><span class="w"> </span><span class="nv">Root</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">is_valid_merkle_branch_aux</span><span class="p">(</span><span class="nv">Branch</span><span class="p">,</span><span class="w"> </span><span class="nv">Depth</span><span class="p">,</span><span class="w"> </span><span class="nv">Index</span><span class="p">,</span><span class="w"> </span><span class="nv">Root</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">Leaf</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_valid_merkle_branch_aux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BytesList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_valid_merkle_branch_aux</span><span class="p">(</span><span class="nv">Branch</span><span class="p">,</span><span class="w"> </span><span class="nv">Depth</span><span class="p">,</span><span class="w"> </span><span class="nv">Index</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">Value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">Index</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="err">^</span><span class="nv">Int</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#then</span><span class="w"> </span><span class="p">{</span><span class="nv">hash</span><span class="p">(</span><span class="nv">Branch</span><span class="p">[</span><span class="nv">I</span><span class="p">]</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">Value</span><span class="p">)}:&gt;</span><span class="nv">Hash</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#else</span><span class="w"> </span><span class="p">{</span><span class="nv">hash</span><span class="p">(</span><span class="nv">Value</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">Branch</span><span class="p">[</span><span class="nv">I</span><span class="p">])}:&gt;</span><span class="nv">Hash</span><span class="w"></span>
<span class="w">                                           </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">                                 </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Depth</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">is_valid_merkle_branch_aux</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">Depth</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">Root</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">Value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Root</span><span class="w"> </span><span class="o">==</span><span class="nv">String</span><span class="w"> </span><span class="nv">Value</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Depth</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Helper functions -- Misc</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="compute-shuffled-index">
<span id="compute-shuffled-index"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_shuffled_index</span></code><a class="headerlink" href="#compute-shuffled-index" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_shuffled_index</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">index_count</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Hash</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidatorIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the shuffled validator index corresponding to ``seed`` (and ``index_count``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">index_count</span>

    <span class="c1"># Swap or not (https://link.springer.com/content/pdf/10.1007%2F978-3-642-32009-5_1.pdf)</span>
    <span class="c1"># See the &#39;generalized domain&#39; algorithm on page 3</span>
    <span class="k">for</span> <span class="n">current_round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SHUFFLE_ROUND_COUNT</span><span class="p">):</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">bytes_to_int</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">current_round</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span> <span class="o">%</span> <span class="n">index_count</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="n">ValidatorIndex</span><span class="p">((</span><span class="n">pivot</span> <span class="o">+</span> <span class="n">index_count</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span> <span class="o">%</span> <span class="n">index_count</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flip</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">current_round</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">position</span> <span class="o">//</span> <span class="mi">256</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">source</span><span class="p">[(</span><span class="n">position</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">]</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">position</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">flip</span> <span class="k">if</span> <span class="n">bit</span> <span class="k">else</span> <span class="n">index</span>

    <span class="k">return</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_shuffled_index&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_shuffled_index</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_shuffled_index_loop</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">SHUFFLE_ROUND_COUNT</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">COUNT</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_shuffled_index_loop&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_shuffled_index_loop</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">computeBit</span><span class="p">(</span><span class="nv">maxInt</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">computeFlip</span><span class="p">(</span><span class="nv">computePivot</span><span class="p">(</span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">),</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="nv">#then</span><span class="w"> </span><span class="nv">computeFlip</span><span class="p">(</span><span class="nv">computePivot</span><span class="p">(</span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">),</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="nv">#else</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"></span>
<span class="w">                  </span><span class="nv">#fi</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">SEED</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">CurrRound</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">CurrRound</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">RoundCount</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">CurrRound</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">RoundCount</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_shuffled_index_loop</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="nv">RoundCount</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">CurrRound</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">RoundCount</span><span class="w"></span>

<span class="c1">//        byte = source[(position % 256) // 8]</span>
<span class="c1">//        bit = (byte &gt;&gt; (position % 8)) % 2</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeBit</span><span class="p">(</span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* position */</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="cm">/* seed */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* current round */</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeBit</span><span class="p">(</span><span class="nv">Position</span><span class="p">,</span><span class="w"> </span><span class="nv">Seed</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">ordChar</span><span class="p">(</span><span class="w"> </span><span class="nv">substrString</span><span class="p">({</span><span class="nv">computeSource</span><span class="p">(</span><span class="nv">Position</span><span class="p">,</span><span class="w"> </span><span class="nv">Seed</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">)}:&gt;</span><span class="nv">String</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="nv">Position</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="nv">Position</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">^</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">Position</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w">  </span><span class="c1">// shifting right by (position % 8)</span>
<span class="w">       </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeSource</span><span class="p">(</span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* position */</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="cm">/* seed */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* current round */</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeSource</span><span class="p">(</span><span class="nv">Position</span><span class="p">,</span><span class="w"> </span><span class="nv">Seed</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">hash</span><span class="p">(({</span><span class="nv">Seed</span><span class="p">}:&gt;</span><span class="nv">Bytes</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">Position</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeFlip</span><span class="p">(</span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* pivot */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* index */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* count */</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeFlip</span><span class="p">(</span><span class="nv">Pivot</span><span class="p">,</span><span class="w"> </span><span class="nv">Index</span><span class="p">,</span><span class="w"> </span><span class="nv">Count</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">Pivot</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Index</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">Count</span><span class="w"></span>

<span class="w">  </span><span class="c1">//pivot = bytes_to_int(hash(seed + int_to_bytes(current_round, length=1))[0:8]) % index_count</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computePivot</span><span class="p">(</span><span class="nv">Hash</span><span class="w"> </span><span class="cm">/* seed */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* current round */</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/* index count */</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computePivot</span><span class="p">(</span><span class="nv">Seed</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="nv">Count</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">bytes_to_int</span><span class="p">(</span><span class="nv">substrString</span><span class="p">({</span><span class="nv">hash</span><span class="p">({</span><span class="nv">Seed</span><span class="p">}:&gt;</span><span class="nv">Bytes</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">CurrRound</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))}:&gt;</span><span class="nv">String</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">Count</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="compute-proposer-index">
<span id="compute-proposer-index"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_proposer_index</span></code><a class="headerlink" href="#compute-proposer-index" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">],</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Hash</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidatorIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return from ``indices`` a random index sampled by effective balance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">MAX_RANDOM_BYTE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">candidate_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">compute_shuffled_index</span><span class="p">(</span><span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">seed</span><span class="p">)]</span>
        <span class="n">random_byte</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">32</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">))[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">32</span><span class="p">]</span>
        <span class="n">effective_balance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">candidate_index</span><span class="p">]</span><span class="o">.</span><span class="n">effective_balance</span>
        <span class="k">if</span> <span class="n">effective_balance</span> <span class="o">*</span> <span class="n">MAX_RANDOM_BYTE</span> <span class="o">&gt;=</span> <span class="n">MAX_EFFECTIVE_BALANCE</span> <span class="o">*</span> <span class="n">random_byte</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">candidate_index</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_proposer_index&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_proposer_index</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">computeProposerIndexLoop</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDICES</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">.IntList</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeProposerIndexLoop</span><span class="p">(</span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeProposerIndexLoop</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">CandidateIndex</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">RandomByte</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">EffectiveBalance</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">computeProposerIndexLoopAux</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">EffectiveBalance</span><span class="p">,</span><span class="w"> </span><span class="nv">RandomByte</span><span class="p">,</span><span class="w"> </span><span class="nv">CandidateIndex</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">CandidateIndex</span><span class="p">)</span><span class="nv">.effectiveBalance</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="c1">//random_byte = hash(seed + int_to_bytes(i // 32, length=8))[i % 32]</span>
<span class="w">            </span><span class="p">)(</span><span class="nv">getByte</span><span class="p">(</span><span class="w"> </span><span class="nv">hashConcat</span><span class="p">(</span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)),</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="mi">32</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">)(</span><span class="nv">INDICES</span><span class="p">[</span><span class="nv">compute_shuffled_index</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">),</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">),</span><span class="w"> </span><span class="nv">SEED</span><span class="p">)])</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeProposerIndexLoopAux</span><span class="p">(</span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeProposerIndexLoopAux</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">EffectiveBalance</span><span class="p">,</span><span class="w"> </span><span class="nv">RandomByte</span><span class="p">,</span><span class="w"> </span><span class="nv">CandidateIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nv">computeProposerIndexLoop</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">EffectiveBalance</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="err">^</span><span class="nv">Int</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">RandomByte</span><span class="w"></span>
<span class="w">                              </span><span class="c1">//MAX_RANDOM_BYTE</span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeProposerIndexLoopAux</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">EffectiveBalance</span><span class="p">,</span><span class="w"> </span><span class="nv">RandomByte</span><span class="p">,</span><span class="w"> </span><span class="nv">CandidateIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nv">CandidateIndex</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">EffectiveBalance</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="err">^</span><span class="nv">Int</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">RandomByte</span><span class="w"></span>
<span class="w">                              </span><span class="c1">//MAX_RANDOM_BYTE</span>
</pre></div>
</div>
</div>
<div class="section" id="compute-committee">
<span id="compute-committee"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_committee</span></code><a class="headerlink" href="#compute-committee" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_committee</span><span class="p">(</span><span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">],</span>
                      <span class="n">seed</span><span class="p">:</span> <span class="n">Hash</span><span class="p">,</span>
                      <span class="n">index</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span>
                      <span class="n">count</span><span class="p">:</span> <span class="n">uint64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the committee corresponding to ``indices``, ``seed``, ``index``, and committee ``count``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">count</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="n">count</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">compute_shuffled_index</span><span class="p">(</span><span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">seed</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_committee&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_committee</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">computeCommitteeLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">len</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">)</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">len</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">)</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nv">SEED</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nv">INDICES</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nv">.IntList</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeCommitteeLoop</span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeCommitteeLoop</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">END</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">,</span><span class="w"> </span><span class="nv">INDICES</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="nv">RESULT</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RESULT</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">INDICES</span><span class="p">[</span><span class="nv">compute_shuffled_index</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">),</span><span class="w"> </span><span class="nv">SEED</span><span class="p">)]</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="k">END</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeCommitteeLoop</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="k">END</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">RESULT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RESULT</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="k">END</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="compute-epoch-at-slot">
<span id="compute-epoch-at-slot"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_epoch_at_slot</span></code><a class="headerlink" href="#compute-epoch-at-slot" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_epoch_at_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the epoch number of ``slot``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">slot</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_epoch_at_slot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_epoch_at_slot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="compute-start-slot-at-epoch">
<span id="compute-start-slot-at-epoch"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_start_slot_at_epoch</span></code><a class="headerlink" href="#compute-start-slot-at-epoch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Slot</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the start slot of ``epoch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Slot</span><span class="p">(</span><span class="n">epoch</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_start_slot_at_epoch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_start_slot_at_epoch</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="compute-activation-exit-epoch">
<span id="compute-activation-exit-epoch"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_activation_exit_epoch</span></code><a class="headerlink" href="#compute-activation-exit-epoch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the epoch during which validator activations and exits initiated in ``epoch`` take effect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">MAX_SEED_LOOKAHEAD</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_activation_exit_epoch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_activation_exit_epoch</span><span class="p">(</span><span class="nv">EP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">EP</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MAX_SEED_LOOKAHEAD</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="compute-domain">
<span id="compute-domain"></span><h2><code class="docutils literal notranslate"><span class="pre">compute_domain</span></code><a class="headerlink" href="#compute-domain" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_domain</span><span class="p">(</span><span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">,</span> <span class="n">fork_version</span><span class="p">:</span> <span class="n">Version</span><span class="o">=</span><span class="n">Version</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Domain</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the domain for the ``domain_type`` and ``fork_version``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Domain</span><span class="p">(</span><span class="n">domain_type</span> <span class="o">+</span> <span class="n">fork_version</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Domain</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;compute_domain&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">DomainType</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Version</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">    </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">compute_domain</span><span class="p">(</span><span class="nv">Domain_Type</span><span class="p">,</span><span class="w"> </span><span class="nv">Fork_Version</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="nv">Domain_Type</span><span class="w"> </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">Fork_Version</span><span class="p">}:&gt;</span><span class="nv">Domain</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Helper functions -- Beacon state accessors</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="get-current-epoch">
<span id="get-current-epoch"></span><h2><code class="docutils literal notranslate"><span class="pre">get_current_epoch</span></code><a class="headerlink" href="#get-current-epoch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the current epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_current_epoch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_epoch_at_slot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-previous-epoch">
<span id="get-previous-epoch"></span><h2><code class="docutils literal notranslate"><span class="pre">get_previous_epoch</span></code><a class="headerlink" href="#get-previous-epoch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;`</span>
<span class="sd">    Return the previous epoch (unless the current epoch is ``GENESIS_EPOCH``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GENESIS_EPOCH</span> <span class="k">if</span> <span class="n">current_epoch</span> <span class="o">==</span> <span class="n">GENESIS_EPOCH</span> <span class="k">else</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">current_epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_previous_epoch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_previous_epoch</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w">  </span><span class="nv">#if</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"></span>
<span class="w">                                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"></span>
<span class="w">                                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">                                </span><span class="nv">#fi</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-block-root">
<span id="get-block-root"></span><h2><code class="docutils literal notranslate"><span class="pre">get_block_root</span></code><a class="headerlink" href="#get-block-root" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the block root at the start of a recent ``epoch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_block_root&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_block_root</span><span class="p">(</span><span class="nv">EP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_block_root_at_slot</span><span class="p">(</span><span class="nv">compute_start_slot_at_epoch</span><span class="p">(</span><span class="nv">EP</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-block-root-at-slot">
<span id="get-block-root-at-slot"></span><h2><code class="docutils literal notranslate"><span class="pre">get_block_root_at_slot</span></code><a class="headerlink" href="#get-block-root-at-slot" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the block root at a recent ``slot``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">slot</span> <span class="o">+</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">block_roots</span><span class="p">[</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_block_root_at_slot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_block_root_at_slot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="nv">BLOCKROOTS</span><span class="p">[</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="w"> </span><span class="p">]}:&gt;</span><span class="nv">Hash</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">BLOCKROOTS</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">SLOT</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-randao-mix">
<span id="get-randao-mix"></span><h2><code class="docutils literal notranslate"><span class="pre">get_randao_mix</span></code><a class="headerlink" href="#get-randao-mix" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the randao mix at a recent ``epoch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_randao_mix&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_randao_mix</span><span class="p">(</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="nv">RMS</span><span class="p">[</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="w"> </span><span class="p">]}:&gt;</span><span class="nv">Hash</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">RMS</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-active-validator-indices">
<span id="get-active-validator-indices"></span><h2><code class="docutils literal notranslate"><span class="pre">get_active_validator_indices</span></code><a class="headerlink" href="#get-active-validator-indices" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the sequence of active validator indices at ``epoch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_active_validator_indices&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">epoch</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">EP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">getActiveValidatorIndicesAux</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="p">,</span><span class="w"> </span><span class="nv">EP</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getActiveValidatorIndicesAux</span><span class="p">(</span><span class="w"> </span><span class="nv">result</span><span class="p">:</span><span class="w"> </span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">validators</span><span class="p">:</span><span class="w"> </span><span class="nv">Map</span><span class="p">,</span><span class="w"> </span><span class="nv">epoch</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getActiveValidatorIndicesAux</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w">          </span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">V</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"> </span><span class="nv">EP</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span><span class="w"> </span><span class="nv">EP</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getActiveValidatorIndicesAux</span><span class="p">(</span><span class="nv">Is</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Is</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">V</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"> </span><span class="nv">EP</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w">         </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span><span class="w"> </span><span class="nv">EP</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getActiveValidatorIndicesAux</span><span class="p">(</span><span class="nv">Is</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">.Map</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Is</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-validator-churn-limit">
<span id="get-validator-churn-limit"></span><h2><code class="docutils literal notranslate"><span class="pre">get_validator_churn_limit</span></code><a class="headerlink" href="#get-validator-churn-limit" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the validator churn limit for the current epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_validator_indices</span> <span class="o">=</span> <span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">MIN_PER_EPOCH_CHURN_LIMIT</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_validator_indices</span><span class="p">)</span> <span class="o">//</span> <span class="n">CHURN_LIMIT_QUOTIENT</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_validator_churn_limit&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_validator_churn_limit</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">maxInt</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nv">MIN_PER_EPOCH_CHURN_LIMIT</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">len</span><span class="p">(</span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()))</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">CHURN_LIMIT_QUOTIENT</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-seed">
<span id="get-seed"></span><h2><code class="docutils literal notranslate"><span class="pre">get_seed</span></code><a class="headerlink" href="#get-seed" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">,</span> <span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the seed at ``epoch``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mix</span> <span class="o">=</span> <span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span> <span class="o">-</span> <span class="n">MIN_SEED_LOOKAHEAD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Avoid underflow</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">domain_type</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">mix</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_seed&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">DomainType</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_seed</span><span class="p">(</span><span class="nv">Epoch</span><span class="p">,</span><span class="w"> </span><span class="nv">DOMAINTYPE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">hash</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">DOMAINTYPE</span><span class="w"></span>
<span class="w">             </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">Epoch</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"></span>
<span class="w">             </span><span class="err">+</span><span class="nv">Bytes</span><span class="w"> </span><span class="nv">get_randao_mix</span><span class="p">(</span><span class="nv">Epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_SEED_LOOKAHEAD</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-committee-count-at-slot">
<span id="get-committee-count-at-slot"></span><h2><code class="docutils literal notranslate"><span class="pre">get_committee_count_at_slot</span></code><a class="headerlink" href="#get-committee-count-at-slot" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_committee_count_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the number of committees at ``slot``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span>
        <span class="n">MAX_COMMITTEES_PER_SLOT</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">))</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span> <span class="o">//</span> <span class="n">TARGET_COMMITTEE_SIZE</span><span class="p">,</span>
    <span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_committee_count_at_slot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_committee_count_at_slot</span><span class="p">(</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">maxInt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">MAX_COMMITTEES_PER_SLOT</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nv">len</span><span class="p">(</span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">compute_epoch_at_slot</span><span class="p">(</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="p">)))</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">TARGET_COMMITTEE_SIZE</span><span class="w"></span>
<span class="w">                 </span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="k">def</span> <span class="nf">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">CommitteeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the beacon committee at ``slot`` for ``index``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
    <span class="n">committees_per_slot</span> <span class="o">=</span> <span class="n">get_committee_count_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compute_committee</span><span class="p">(</span>
        <span class="n">indices</span><span class="o">=</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">),</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_ATTESTER</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span> <span class="o">*</span> <span class="n">committees_per_slot</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
        <span class="n">count</span><span class="o">=</span><span class="n">committees_per_slot</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">,</span>
    <span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_beacon_committee&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_beacon_committee</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">CommitteesPerSlot</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">EPOCH</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_committee</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="nv">get_seed</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">DOMAIN_BEACON_ATTESTER</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="nv">SLOT</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="p">)</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">CommitteesPerSlot</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">CommitteesPerSlot</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)(</span><span class="nv">compute_epoch_at_slot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">)(</span><span class="nv">get_committee_count_at_slot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-beacon-proposer-index">
<span id="get-beacon-proposer-index"></span><h2><code class="docutils literal notranslate"><span class="pre">get_beacon_proposer_index</span></code><a class="headerlink" href="#get-beacon-proposer-index" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidatorIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the beacon proposer index at the current slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">)</span> <span class="o">+</span> <span class="n">int_to_bytes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compute_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_beacon_proposer_index&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_beacon_proposer_index</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">EPOCH</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">SEED</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">INDICES</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_proposer_index</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="nv">SEED</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">)(</span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="p">)(</span><span class="nv">hashConcat</span><span class="p">(</span><span class="nv">get_seed</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">DOMAIN_BEACON_PROPOSER</span><span class="p">),</span><span class="w"> </span><span class="nv">to_bytes</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)))</span><span class="w"></span>
<span class="w">          </span><span class="p">)(</span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">       </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-total-balance">
<span id="get-total-balance"></span><h2><code class="docutils literal notranslate"><span class="pre">get_total_balance</span></code><a class="headerlink" href="#get-total-balance" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the combined effective balance of the ``indices``. (1 Gwei minimum to avoid divisions by zero.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Gwei</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">effective_balance</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_total_balance&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">maxInt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">getTotalBalancePure</span><span class="p">(</span><span class="nv">INDICES</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getTotalBalancePure</span><span class="p">(</span><span class="w"> </span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getTotalBalancePure</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">S</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">S</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.effectiveBalance</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getTotalBalancePure</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">S</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">S</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-total-active-balance">
<span id="get-total-active-balance"></span><h2><code class="docutils literal notranslate"><span class="pre">get_total_active_balance</span></code><a class="headerlink" href="#get-total-active-balance" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the combined effective balance of the active validators.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_total_active_balance&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_total_active_balance</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-domain">
<span id="get-domain"></span><h2><code class="docutils literal notranslate"><span class="pre">get_domain</span></code><a class="headerlink" href="#get-domain" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">,</span> <span class="n">message_epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Domain</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the signature domain (fork version concatenated with domain type) of a message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">message_epoch</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">message_epoch</span>
    <span class="n">fork_version</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">fork</span><span class="o">.</span><span class="n">previous_version</span> <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">.</span><span class="n">fork</span><span class="o">.</span><span class="n">epoch</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">fork</span><span class="o">.</span><span class="n">current_version</span>
    <span class="k">return</span> <span class="n">compute_domain</span><span class="p">(</span><span class="n">domain_type</span><span class="p">,</span> <span class="n">fork_version</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Domain</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_domain&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">DomainType</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">OptionInt</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_domain</span><span class="p">(</span><span class="nv">DTYPE</span><span class="p">,</span><span class="w"> </span><span class="nv">OEPOCH</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_domain_aux</span><span class="p">(</span><span class="nv">DTYPE</span><span class="p">,</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">isNone</span><span class="p">(</span><span class="nv">OEPOCH</span><span class="p">)</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">intOf</span><span class="p">(</span><span class="nv">OEPOCH</span><span class="p">)</span><span class="w"> </span><span class="nv">#fi</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Domain</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_domain_aux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">DomainType</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_domain_aux</span><span class="p">(</span><span class="nv">DTYPE</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_domain</span><span class="p">(</span><span class="nv">DTYPE</span><span class="p">,</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">FEPOCH</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="nv">FPREV</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">FCURR</span><span class="w"> </span><span class="nv">#fi</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">  </span><span class="nt">&lt;fork&gt;</span><span class="w"> </span><span class="nv">#Fork</span><span class="p">(</span><span class="nv">FPREV</span><span class="p">,</span><span class="nv">FCURR</span><span class="p">,</span><span class="nv">FEPOCH</span><span class="p">)</span><span class="w"> </span><span class="nt">&lt;/fork&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-indexed-attestation">
<span id="get-indexed-attestation"></span><h2><code class="docutils literal notranslate"><span class="pre">get_indexed_attestation</span></code><a class="headerlink" href="#get-indexed-attestation" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestation</span><span class="p">:</span> <span class="n">Attestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IndexedAttestation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the indexed attestation corresponding to ``attestation``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attesting_indices</span> <span class="o">=</span> <span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attestation</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">IndexedAttestation</span><span class="p">(</span>
        <span class="n">attesting_indices</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">attesting_indices</span><span class="p">),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">attestation</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">signature</span><span class="o">=</span><span class="n">attestation</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
    <span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IndexedAttestation</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_indexed_attestation&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Attestation</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_indexed_attestation</span><span class="p">(</span><span class="nv">#Attestation</span><span class="p">(</span><span class="nv">AggregationBits</span><span class="p">,</span><span class="w"> </span><span class="nv">DATA</span><span class="p">,</span><span class="w"> </span><span class="nv">SIG</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">AttestingIndices</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#IndexedAttestation</span><span class="p">(</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">sortIntList</span><span class="p">(</span><span class="nv">AttestingIndices</span><span class="p">),</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">DATA</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">SIG</span><span class="w"></span>
<span class="w">                               </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)(</span><span class="nv">get_attesting_indices</span><span class="p">(</span><span class="nv">DATA</span><span class="p">,</span><span class="w"> </span><span class="nv">AggregationBits</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-attesting-indices">
<span id="get-attesting-indices"></span><h2><code class="docutils literal notranslate"><span class="pre">get_attesting_indices</span></code><a class="headerlink" href="#get-attesting-indices" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                          <span class="n">data</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">,</span>
                          <span class="n">bits</span><span class="p">:</span> <span class="n">Bitlist</span><span class="p">[</span><span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the set of attesting indices corresponding to ``data`` and ``bits``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">committee</span> <span class="o">=</span> <span class="n">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">index</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span> <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_attesting_indices&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">AttestationData</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_attesting_indices</span><span class="p">(</span><span class="nv">#AttestationData</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">,</span><span class="nv">INDEX</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">),</span><span class="w"> </span><span class="nv">BL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">extractAttestingIndices</span><span class="p">(</span><span class="nv">get_beacon_committee</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">),</span><span class="w"> </span><span class="nv">BL</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">extractAttestingIndices</span><span class="p">(</span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">BitList</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">extractAttestingIndices</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">true</span><span class="w">  </span><span class="nv">BL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">BL</span><span class="p">,</span><span class="w"> </span><span class="nv">AL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">AL</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">extractAttestingIndices</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">false</span><span class="w"> </span><span class="nv">BL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">BL</span><span class="p">,</span><span class="w"> </span><span class="nv">AL</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">extractAttestingIndices</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">AL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">AL</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Helper functions -- Beacon state mutators</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="increase-balance">
<span id="increase-balance"></span><h2><code class="docutils literal notranslate"><span class="pre">increase_balance</span></code><a class="headerlink" href="#increase-balance" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">Gwei</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Increase the validator balance at index ``index`` by ``delta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;increase_balance&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">increase_balance</span><span class="p">(</span><span class="nv">ValIndex</span><span class="p">,</span><span class="w"> </span><span class="nv">Delta</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;balances&gt;</span><span class="p">...</span><span class="w"> </span><span class="nv">ValIndex</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Delta</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="decrease-balance">
<span id="decrease-balance"></span><h2><code class="docutils literal notranslate"><span class="pre">decrease_balance</span></code><a class="headerlink" href="#decrease-balance" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">Gwei</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decrease the validator balance at index ``index`` by ``delta``, with underflow protection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;decrease_balance&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">decrease_balance</span><span class="p">(</span><span class="nv">ValIndex</span><span class="p">,</span><span class="w"> </span><span class="nv">Delta</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="err">.</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;balances&gt;</span><span class="p">...</span><span class="w"> </span><span class="nv">ValIndex</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">Delta</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">Delta</span><span class="w"> </span><span class="nv">#fi</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="initiate-validator-exit">
<span id="initiate-validator-exit"></span><h2><code class="docutils literal notranslate"><span class="pre">initiate_validator_exit</span></code><a class="headerlink" href="#initiate-validator-exit" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate the exit of the validator with index ``index``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return if validator already initiated exit</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Compute exit queue epoch</span>
    <span class="n">exit_epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span><span class="p">]</span>
    <span class="n">exit_queue_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">exit_epochs</span> <span class="o">+</span> <span class="p">[</span><span class="n">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))])</span>
    <span class="n">exit_queue_churn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">==</span> <span class="n">exit_queue_epoch</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">exit_queue_churn</span> <span class="o">&gt;=</span> <span class="n">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">exit_queue_epoch</span> <span class="o">+=</span> <span class="n">Epoch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set validator exit epoch and withdrawable epoch</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">=</span> <span class="n">exit_queue_epoch</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">withdrawable_epoch</span> <span class="o">=</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">+</span> <span class="n">MIN_VALIDATOR_WITHDRAWABILITY_DELAY</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;initiate_validator_exit&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nv">initiateValidatorExitAux</span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*index*/</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*exit_queue_epoch*/</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">initiate_validator_exit</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="nv">.exitEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">initiate_validator_exit</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">initiateValidatorExitAux</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">exitQueueEpochAux</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="nv">.exitEpoch</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">initiateValidatorExitAux</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nv">VALIDATORS</span><span class="p">:</span><span class="nv">Map</span><span class="w"></span>
<span class="w">       </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nv">ExitEPOCH</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="p">(</span><span class="nv">ExitQEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_validator_churn_limit</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="nv">#then</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">                            </span><span class="nv">#else</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"></span>
<span class="w">                         </span><span class="nv">#fi</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nv">WithdrEpoch</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="p">(</span><span class="nv">ExitQEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_validator_churn_limit</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="nv">#then</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">                            </span><span class="nv">#else</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"></span>
<span class="w">                         </span><span class="nv">#fi</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_VALIDATOR_WITHDRAWABILITY_DELAY</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">exitQueueEpochAux</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">exitQueueEpochAux</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">maxAux</span><span class="p">(</span><span class="nv">compute_activation_exit_epoch</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="nv">exitEpochsAux</span><span class="p">(</span><span class="nv">VALIDATORS</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">exitEpochsAux</span><span class="p">(</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="cm">/*validators*/</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="cm">/*result*/</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitEpochsAux</span><span class="p">(</span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="nv">RES</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitEpochsAux</span><span class="p">(</span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="nv">RES</span><span class="w"> </span><span class="cm">/*unchanged*/</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitEpochsAux</span><span class="p">(</span><span class="nv">.Map</span><span class="p">,</span><span class="w"> </span><span class="nv">RES</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RES</span><span class="w"></span>

<span class="w">  </span><span class="c1">// exit_queue_churn = len([v for v in state.validator_registry if v.exit_epoch == exit_queue_epoch])</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*exit_queue_epoch*/</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="cm">/*validator_registry*/</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*result*/</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="p">(</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w">  </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="p">(</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.exitEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">ExitQEpoch</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">exitQueueChurnAux</span><span class="p">(</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">.Map</span><span class="p">,</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RES</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="slash-validator">
<span id="slash-validator"></span><h2><code class="docutils literal notranslate"><span class="pre">slash_validator</span></code><a class="headerlink" href="#slash-validator" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                    <span class="n">slashed_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span>
                    <span class="n">whistleblower_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Slash the validator with index ``slashed_index``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">slashed_index</span><span class="p">)</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">slashed_index</span><span class="p">]</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">slashed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">withdrawable_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">withdrawable_epoch</span><span class="p">,</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">))</span>
    <span class="n">state</span><span class="o">.</span><span class="n">slashings</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">]</span> <span class="o">+=</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span>
    <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">slashed_index</span><span class="p">,</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">MIN_SLASHING_PENALTY_QUOTIENT</span><span class="p">)</span>

    <span class="c1"># Apply proposer and whistleblower rewards</span>
    <span class="n">proposer_index</span> <span class="o">=</span> <span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">whistleblower_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">whistleblower_index</span> <span class="o">=</span> <span class="n">proposer_index</span>
    <span class="n">whistleblower_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">WHISTLEBLOWER_REWARD_QUOTIENT</span><span class="p">)</span>
    <span class="n">proposer_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">whistleblower_reward</span> <span class="o">//</span> <span class="n">PROPOSER_REWARD_QUOTIENT</span><span class="p">)</span>
    <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">proposer_index</span><span class="p">,</span> <span class="n">proposer_reward</span><span class="p">)</span>
    <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">whistleblower_index</span><span class="p">,</span> <span class="n">whistleblower_reward</span> <span class="o">-</span> <span class="n">proposer_reward</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;slash_validator&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="err">/*</span><span class="nv">slashed_index</span><span class="w"></span>
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">                                         </span><span class="nv">ValidatorIndex</span><span class="w">     </span><span class="cm">/*whistleblower_index or .ValidatorIndex if none*/</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>

<span class="w">    </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">slash_validator</span><span class="p">(</span><span class="nv">SlashedINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">WhistleblINDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">initiate_validator_exit</span><span class="p">(</span><span class="nv">SlashedINDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">slashValidatorAux</span><span class="p">(</span><span class="nv">SlashedINDEX</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">#if</span><span class="w"> </span><span class="nv">WhistleblINDEX</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="nv">get_beacon_proposer_index</span><span class="p">()</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">WhistleblINDEX</span><span class="w"> </span><span class="nv">#fi</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">get_beacon_proposer_index</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">VAL.effectiveBalance</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">WHISTLEBLOWER_REWARD_QUOTIENT</span><span class="p">,</span><span class="w"> </span><span class="c1">//whistleblower_reward</span>
<span class="w">                                  </span><span class="nv">VAL.effectiveBalance</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">WHISTLEBLOWER_REWARD_QUOTIENT</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">PROPOSER_REWARD_QUOTIENT</span><span class="p">,</span><span class="w"> </span><span class="c1">//proposer_reward</span>
<span class="w">                                  </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"> </span><span class="c1">//epoch</span>
<span class="w">          </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">SlashedINDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w"> </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;slashValidatorAux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">    </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">slashValidatorAux</span><span class="p">(</span><span class="nv">SlashedINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">WhistleblINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">ProposerINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">WhistleREWARD</span><span class="p">,</span><span class="w"> </span><span class="nv">ProposerREWARD</span><span class="p">,</span><span class="w"> </span><span class="nv">Epoch</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">decrease_balance</span><span class="p">(</span><span class="nv">SlashedINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">EffBALANCE</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_SLASHING_PENALTY_QUOTIENT</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">increase_balance</span><span class="p">(</span><span class="nv">ProposerINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">ProposerREWARD</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">increase_balance</span><span class="p">(</span><span class="nv">WhistleblINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">WhistleREWARD</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">ProposerREWARD</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nt">&lt;validators&gt;</span><span class="w"></span>
<span class="w">        </span><span class="nv">SlashedINDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">EffBALANCE</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">true</span><span class="p">,</span><span class="w"> </span><span class="c1">//slashed</span>
<span class="w">          </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">WithdEPOCH</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">maxInt</span><span class="p">(</span><span class="nv">WithdEPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">Epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">)</span><span class="w"> </span><span class="c1">//withdrawable epoch</span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nt">&lt;slashings&gt;</span><span class="w"> </span><span class="nv">Epoch</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">SL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">SL</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EffBALANCE</span><span class="p">)</span><span class="w">  </span><span class="p">...</span><span class="nt">&lt;/slashings&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Genesis state</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">initialize_beacon_state_from_eth1</span><span class="p">(</span><span class="n">eth1_block_hash</span><span class="p">:</span> <span class="n">Hash</span><span class="p">,</span>
                                      <span class="n">eth1_timestamp</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span>
                                      <span class="n">deposits</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Deposit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BeaconState</span><span class="p">:</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">BeaconState</span><span class="p">(</span>
        <span class="n">genesis_time</span><span class="o">=</span><span class="n">eth1_timestamp</span> <span class="o">-</span> <span class="n">eth1_timestamp</span> <span class="o">%</span> <span class="n">SECONDS_PER_DAY</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SECONDS_PER_DAY</span><span class="p">,</span>
        <span class="n">eth1_data</span><span class="o">=</span><span class="n">Eth1Data</span><span class="p">(</span><span class="n">block_hash</span><span class="o">=</span><span class="n">eth1_block_hash</span><span class="p">,</span> <span class="n">deposit_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">deposits</span><span class="p">)),</span>
        <span class="n">latest_block_header</span><span class="o">=</span><span class="n">BeaconBlockHeader</span><span class="p">(</span><span class="n">body_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">BeaconBlockBody</span><span class="p">())),</span>
        <span class="n">randao_mixes</span><span class="o">=</span><span class="p">[</span><span class="n">eth1_block_hash</span><span class="p">]</span> <span class="o">*</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">,</span>  <span class="c1"># Seed RANDAO with Eth1 entropy</span>
    <span class="p">)</span>

    <span class="c1"># Process deposits</span>
    <span class="n">leaves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deposits</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deposits</span><span class="p">):</span>
        <span class="n">deposit_data_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">DepositData</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="p">](</span><span class="o">*</span><span class="n">leaves</span><span class="p">[:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">state</span><span class="o">.</span><span class="n">eth1_data</span><span class="o">.</span><span class="n">deposit_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">deposit_data_list</span><span class="p">)</span>
        <span class="n">process_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">deposit</span><span class="p">)</span>

    <span class="c1"># Process activations</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">balance</span> <span class="o">-</span> <span class="n">balance</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">==</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>

    <span class="k">return</span> <span class="n">state</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;initialize_beacon_state_from_eth1&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">DepositList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">initialize_beacon_state_from_eth1</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">initialize_beacon_state_from_eth1</span><span class="p">(</span><span class="nv">E1BH</span><span class="p">,</span><span class="w"> </span><span class="nv">E1TS</span><span class="p">,</span><span class="w"> </span><span class="nv">Deposits</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">stateInit</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processEth1Deposits</span><span class="p">(</span><span class="nv">Deposits</span><span class="p">,</span><span class="w"> </span><span class="nv">getDataList</span><span class="p">(</span><span class="nv">Deposits</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">genesis</span><span class="err">-</span><span class="nv">time</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">E1TS</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">E1TS</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SECONDS_PER_DAY</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SECONDS_PER_DAY</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">genesis</span><span class="err">-</span><span class="nv">time</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#Eth1Data</span><span class="p">(</span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">Deposits</span><span class="p">),</span><span class="w"> </span><span class="nv">E1BH</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">fillInVector</span><span class="p">(</span><span class="nv">E1BH</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">              </span><span class="c1">//BeaconBlockHeader(body_root=hash_tree_root(BeaconBlockBody()))</span>
<span class="w">         </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#BeaconBlockHeader</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w"> </span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w"> </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">defaultBeaconBlockBody</span><span class="p">()),</span><span class="w"> </span><span class="nv">defaultBLSSignature</span><span class="p">())</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">//Full state initialization, when generating genesis state</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;stateInit&quot;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">stateInit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;fork&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#Fork</span><span class="p">({</span><span class="nv">defaultBytes4</span><span class="p">()}:&gt;</span><span class="nv">Version</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">defaultBytes4</span><span class="p">()}:&gt;</span><span class="nv">Version</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nt">&lt;/fork&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w">  </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">fillInMap</span><span class="p">(</span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w"> </span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="c1">//Vector[Hash, SLOTS_PER_HISTORICAL_ROOT]</span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w">  </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">fillInMap</span><span class="p">(</span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w"> </span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="c1">//Vector[Hash, SLOTS_PER_HISTORICAL_ROOT]</span>
<span class="w">       </span><span class="nt">&lt;slashings&gt;</span><span class="w">    </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">fillInMap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">)</span><span class="w"> </span><span class="nt">&lt;/slashings&gt;</span><span class="w"> </span><span class="c1">//Vector[Gwei, EPOCHS_PER_SLASHINGS_VECTOR]</span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">false</span><span class="w">  </span><span class="nv">false</span><span class="w">  </span><span class="nv">false</span><span class="w">  </span><span class="nv">false</span><span class="w">  </span><span class="nv">.BitList</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="c1">//Bitvector[JUSTIFICATION_BITS_LENGTH]</span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">defaultCheckpoint</span><span class="p">()</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">defaultCheckpoint</span><span class="p">()</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">defaultCheckpoint</span><span class="p">()</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="n">leaves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deposits</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deposits</span><span class="p">):</span>
        <span class="n">deposit_data_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">DepositData</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="p">](</span><span class="o">*</span><span class="n">leaves</span><span class="p">[:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">state</span><span class="o">.</span><span class="n">eth1_data</span><span class="o">.</span><span class="n">deposit_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">deposit_data_list</span><span class="p">)</span>
        <span class="n">process_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">deposit</span><span class="p">)</span> 
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processEth1Deposits&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">DepositList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">DepositDataList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_deposit</span><span class="p">(</span><span class="nv">Dep</span><span class="p">))</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processEth1Deposits</span><span class="p">(</span><span class="nv">Dep</span><span class="w"> </span><span class="nv">Deposits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Deposits</span><span class="p">,</span><span class="w"> </span><span class="nv">Leaves</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">ETH1Data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">setDepositRoot</span><span class="p">(</span><span class="nv">ETH1Data</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="c1">//List[DepositData, 2**DEPOSIT_CONTRACT_TREE_DEPTH]</span>
<span class="w">            </span><span class="nv">hash_tree_root_list</span><span class="p">(</span><span class="nv">slice</span><span class="p">(</span><span class="nv">Leaves</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">^</span><span class="nv">Int</span><span class="w"> </span><span class="nv">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="p">,</span><span class="w"> </span><span class="nv">%container</span><span class="p">,</span><span class="w"> </span><span class="nv">false</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processEth1Deposits</span><span class="p">(</span><span class="nv">.DepositList</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Eth1Data</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">setDepositRoot</span><span class="p">(</span><span class="nv">Eth1Data</span><span class="p">,</span><span class="w"> </span><span class="nv">Hash</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">setDepositRoot</span><span class="p">(</span><span class="nv">#Eth1Data</span><span class="p">(</span><span class="nv">DROOT</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"> </span><span class="nv">BHASH</span><span class="p">),</span><span class="w"> </span><span class="nv">NewDROOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#Eth1Data</span><span class="p">(</span><span class="nv">NewDROOT</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">,</span><span class="w"> </span><span class="nv">BHASH</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">DepositDataList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getDataList</span><span class="p">(</span><span class="nv">DepositList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getDataList</span><span class="p">(</span><span class="nv">Dep</span><span class="w"> </span><span class="nv">Deps</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Dep.data</span><span class="w"> </span><span class="nv">getDataList</span><span class="p">(</span><span class="nv">Deps</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getDataList</span><span class="p">(</span><span class="nv">.DepositList</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.DepositDataList</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">balance</span> <span class="o">-</span> <span class="n">balance</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">==</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>  
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processEth1Activations&quot;</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">numOfValidators</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;balances&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="p">(</span><span class="nv">AEE</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#then</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#else</span><span class="w"> </span><span class="nv">AEE</span><span class="w"></span>
<span class="w">                                         </span><span class="nv">#fi</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="p">(</span><span class="nv">AE</span><span class="w">  </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#then</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"></span>
<span class="w">                                            </span><span class="nv">#else</span><span class="w"> </span><span class="nv">AE</span><span class="w"></span>
<span class="w">                                         </span><span class="nv">#fi</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">COUNT</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processEth1Activations</span><span class="p">(</span><span class="nv">COUNT</span><span class="p">,</span><span class="w"> </span><span class="nv">COUNT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="is-valid-genesis-state">
<span id="is-valid-genesis-state"></span><h2><code class="docutils literal notranslate"><span class="pre">is_valid_genesis_state</span></code><a class="headerlink" href="#is-valid-genesis-state" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_valid_genesis_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">genesis_time</span> <span class="o">&lt;</span> <span class="n">MIN_GENESIS_TIME</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">GENESIS_EPOCH</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">MIN_GENESIS_ACTIVE_VALIDATOR_COUNT</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;is_valid_genesis_state&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">                    </span><span class="p">[</span><span class="nv">function</span><span class="p">,</span><span class="w"> </span><span class="nv">klabel</span><span class="p">(</span><span class="nv">is_valid_genesis_state</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">is_valid_genesis_state</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">Gtime</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_GENESIS_TIME</span><span class="w"></span>
<span class="w">              </span><span class="nv">orBool</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">get_active_validator_indices</span><span class="p">(</span><span class="nv">GENESIS_EPOCH</span><span class="p">))</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_GENESIS_ACTIVE_VALIDATOR_COUNT</span><span class="w"></span>
<span class="w">          </span><span class="nv">#then</span><span class="w"> </span><span class="nv">false</span><span class="w"></span>
<span class="w">          </span><span class="nv">#else</span><span class="w"> </span><span class="nv">true</span><span class="w"></span>
<span class="w">          </span><span class="nv">#fi</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">genesis</span><span class="err">-</span><span class="nv">time</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Gtime</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">genesis</span><span class="err">-</span><span class="nv">time</span><span class="err">&gt;</span><span class="w"></span>


<span class="w">  </span><span class="c1">// Beacon chain state transition function</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="state-transition">
<span id="state-transition"></span><h2><code class="docutils literal notranslate"><span class="pre">state_transition</span></code><a class="headerlink" href="#state-transition" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">state_transition</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">BeaconBlock</span><span class="p">,</span> <span class="n">validate_state_root</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BeaconState</span><span class="p">:</span>
    <span class="c1"># Process slots (including those with no blocks) since block</span>
    <span class="n">process_slots</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="c1"># Process block</span>
    <span class="n">process_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="c1"># Validate state root (`validate_state_root == True` in production)</span>
    <span class="k">if</span> <span class="n">validate_state_root</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">block</span><span class="o">.</span><span class="n">state_root</span> <span class="o">==</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># Return post-state</span>
    <span class="k">return</span> <span class="n">state</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;state_transition&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">block</span><span class="p">:</span><span class="w"> </span><span class="nv">BeaconBlock</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">validateStateRoot</span><span class="p">:</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">  </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">state_transition</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">state_transition</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">,</span><span class="w"> </span><span class="nv">VSR</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_slots</span><span class="p">(</span><span class="nv">BLOCK._slot</span><span class="p">)</span><span class="w"> </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_block</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">)</span><span class="w"> </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">validateStateRoot</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">,</span><span class="w"> </span><span class="nv">VSR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">validateStateRoot</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">BeaconBlock</span><span class="p">,</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">rule</span><span class="w"> </span><span class="nv">validateStateRoot</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">,</span><span class="w"> </span><span class="nv">VSR</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">      </span><span class="nv">requires</span><span class="w"> </span><span class="p">(</span><span class="nv">notBool</span><span class="w"> </span><span class="nv">VSR</span><span class="p">)</span><span class="w"> </span><span class="nv">orBool</span><span class="w"> </span><span class="p">(</span><span class="nv">BLOCK.stateRoot</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">hash_tree_root_state</span><span class="p">())</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-slots">
<span id="process-slots"></span><h2><code class="docutils literal notranslate"><span class="pre">process_slots</span></code><a class="headerlink" href="#process-slots" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_slots</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">slot</span>
    <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="n">slot</span><span class="p">:</span>
        <span class="n">process_slot</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="c1"># Process epoch on the start slot of the next epoch</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SLOTS_PER_EPOCH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">process_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">+=</span> <span class="n">Slot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_slots&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">                      </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_slots</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_slots</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processSlotsLoop</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processSlotsLoop&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processSlotsLoop</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">             </span><span class="nv">process_slot</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="p">(</span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="nv">process_epoch</span><span class="p">()</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">incrementSlot</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processSlotsLoop</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processSlotsLoop</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;incrementSlot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">incrementSlot</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">StateSLOT</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-slot">
<span id="process-slot"></span><h2><code class="docutils literal notranslate"><span class="pre">process_slot</span></code><a class="headerlink" href="#process-slot" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Cache state root</span>
    <span class="n">previous_state_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">state_roots</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state_root</span>
    <span class="c1"># Cache latest block header state root</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="o">.</span><span class="n">state_root</span> <span class="o">==</span> <span class="n">Bytes32</span><span class="p">():</span>
        <span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="o">.</span><span class="n">state_root</span> <span class="o">=</span> <span class="n">previous_state_root</span>
    <span class="c1"># Cache block root</span>
    <span class="n">previous_block_root</span> <span class="o">=</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">block_roots</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_block_root</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_slot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_slot</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processSlotAux</span><span class="p">(</span><span class="nv">hash_tree_root_state</span><span class="p">(),</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processSlotAux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">previousStateRoot</span><span class="p">:</span><span class="w"> </span><span class="nv">Hash</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">stateRootsIndex</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processSlotAux</span><span class="p">(</span><span class="nv">PreviousStateRoot</span><span class="p">,</span><span class="w"> </span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">cacheBlockRoot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PreviousStateRoot</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="err">&lt;/</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">#BeaconBlockHeader</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">BHStateRoot</span><span class="w"></span>
<span class="w">                                                     </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">BHStateRoot</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">defaultBytes32</span><span class="p">()</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">#then</span><span class="w"> </span><span class="nv">PreviousStateRoot</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">#else</span><span class="w"> </span><span class="nv">BHStateRoot</span><span class="w"></span>
<span class="w">                                                        </span><span class="nv">#fi</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;cacheBlockRoot&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">cacheBlockRoot</span><span class="p">(</span><span class="nv">SLOT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">LatestBlockHEADER</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">signing_root</span><span class="p">(</span><span class="nv">LatestBlockHEADER</span><span class="p">))</span><span class="w"> </span><span class="p">...</span><span class="err">&lt;/</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>


<span class="w">  </span><span class="c1">// State transition function -- Epoch processing</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="process-epoch">
<span id="process-epoch"></span><h2><code class="docutils literal notranslate"><span class="pre">process_epoch</span></code><a class="headerlink" href="#process-epoch" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">process_justification_and_finalization</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_rewards_and_penalties</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_registry_updates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># @process_reveal_deadlines</span>
    <span class="c1"># @process_challenge_deadlines</span>
    <span class="n">process_slashings</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_final_updates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># @after_process_final_updates</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_epoch&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_epoch</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">                </span><span class="nv">process_justification_and_finalization</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_rewards_and_penalties</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_registry_updates</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_slashings</span><span class="p">()</span><span class="w"></span>
<span class="w">             </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_final_updates</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-matching-source-attestations">
<span id="get-matching-source-attestations"></span><h2><code class="docutils literal notranslate"><span class="pre">get_matching_source_attestations</span></code><a class="headerlink" href="#get-matching-source-attestations" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">current_epoch_attestations</span> <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">previous_epoch_attestations</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_matching_source_attestations&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">#if</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="nv">#then</span><span class="w"> </span><span class="nv">CEA</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">PEA</span><span class="w"> </span><span class="nv">#fi</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CEA</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">PEA</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">EPOCH</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="p">(</span><span class="nv">SetItem</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())</span><span class="w">  </span><span class="nv">SetItem</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-matching-target-attestations">
<span id="get-matching-target-attestations"></span><h2><code class="docutils literal notranslate"><span class="pre">get_matching_target_attestations</span></code><a class="headerlink" href="#get-matching-target-attestations" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">root</span> <span class="o">==</span> <span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="p">]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_matching_target_attestations&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">filterOutNonMatchingTargets</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">),</span><span class="w"> </span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">.PendingAttestationList</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">filterOutNonMatchingTargets</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingTargets</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAList</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAList</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RES</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">PA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">PA.data.target.root</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_block_root</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingTargets</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAList</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAList</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">RES</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">PA.data.target.root</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_block_root</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingTargets</span><span class="p">(</span><span class="nv">.PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">EPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">RES</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RES</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-matching-head-attestations">
<span id="get-matching-head-attestations"></span><h2><code class="docutils literal notranslate"><span class="pre">get_matching_head_attestations</span></code><a class="headerlink" href="#get-matching-head-attestations" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_matching_head_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">beacon_block_root</span> <span class="o">==</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="p">]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_matching_head_attestations&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_matching_head_attestations</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">filterOutNonMatchingHeads</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">EPOCH</span><span class="p">),</span><span class="w"> </span><span class="nv">.PendingAttestationList</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">filterOutNonMatchingHeads</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingHeads</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">PAL</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="err">&#39;</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">PA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">PA.data.beaconBlockRoot</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_block_root_at_slot</span><span class="p">(</span><span class="nv">PA.data._slot</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingHeads</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">PAL</span><span class="err">&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">PA.data.beaconBlockRoot</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_block_root_at_slot</span><span class="p">(</span><span class="nv">PA.data._slot</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutNonMatchingHeads</span><span class="p">(</span><span class="nv">.PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">PAL</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="err">&#39;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-unslashed-attesting-indices">
<span id="get-unslashed-attesting-indices"></span><h2><code class="docutils literal notranslate"><span class="pre">get_unslashed_attesting_indices</span></code><a class="headerlink" href="#get-unslashed-attesting-indices" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                                    <span class="n">attestations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[ValidatorIndex]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attestations</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">slashed</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_unslashed_attesting_indices&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">PAL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">getAttestingIndicesLoop</span><span class="p">(</span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// merging, instead of concatenation, of lists is performed</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getAttestingIndicesLoop</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getAttestingIndicesLoop</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">IL</span><span class="w"> </span><span class="err">++</span><span class="nv">IntList</span><span class="w"> </span><span class="nv">get_attesting_indices</span><span class="p">(</span><span class="nv">PA.data</span><span class="p">,</span><span class="w"> </span><span class="nv">PA.aggregationBits</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getAttestingIndicesLoop</span><span class="p">(</span><span class="nv">.PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">IntList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.slashed</span><span class="w"></span>
<span class="w">                                          </span><span class="nv">#then</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">IL</span><span class="p">)</span><span class="w"></span>
<span class="w">                                          </span><span class="nv">#else</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">IL</span><span class="p">)</span><span class="w"></span>
<span class="w">                                        </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterOutSlashedIndices</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.IntList</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-attesting-balance">
<span id="get-attesting-balance"></span><h2><code class="docutils literal notranslate"><span class="pre">get_attesting_balance</span></code><a class="headerlink" href="#get-attesting-balance" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_attesting_balance&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_attesting_balance</span><span class="p">(</span><span class="nv">PAL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">PAL</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-justification-and-finalization">
<span id="process-justification-and-finalization"></span><h2><code class="docutils literal notranslate"><span class="pre">process_justification_and_finalization</span></code><a class="headerlink" href="#process-justification-and-finalization" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_justification_and_finalization</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">GENESIS_EPOCH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">old_previous_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span>
    <span class="n">old_current_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span>

    <span class="c1"># Process justifications</span>
    <span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span>
    <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>  <span class="c1"># Previous epoch</span>
    <span class="k">if</span> <span class="n">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">previous_epoch</span><span class="p">,</span>
                                                        <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">)</span>  <span class="c1"># Current epoch</span>
    <span class="k">if</span> <span class="n">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">current_epoch</span><span class="p">,</span>
                                                        <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1</span>

    <span class="c1"># Process finalizations</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span>
    <span class="c1"># The 2nd/3rd/4th most recent epochs are justified, the 2nd using the 4th as source</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_previous_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_previous_justified_checkpoint</span>
    <span class="c1"># The 2nd/3rd most recent epochs are justified, the 2nd using the 3rd as source</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_previous_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_previous_justified_checkpoint</span>
    <span class="c1"># The 1st/2nd/3rd most recent epochs are justified, the 1st using the 3rd as source</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_current_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_current_justified_checkpoint</span>
    <span class="c1"># The 1st/2nd most recent epochs are justified, the 1st using the 2nd as source</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_current_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_current_justified_checkpoint</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_justification_and_finalization&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_justification_and_finalization</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="c1">// too early to proceed with processing</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">process_justification_and_finalization</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span>
    <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_justification_and_finalization</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">updateJustificationPrev</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">updateJustificationCurr</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">updateFinalization</span><span class="p">(</span><span class="nv">PrevJustCHECKP</span><span class="p">,</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">PrevJustCHECKP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">false</span><span class="w"> </span><span class="nv">removeLast</span><span class="p">(</span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>  <span class="c1"># Previous epoch</span>
    <span class="k">if</span> <span class="n">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">previous_epoch</span><span class="p">,</span>
                                                        <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateJustificationPrev&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateJustificationPrev</span><span class="p">(</span><span class="nv">PrevEPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">PrevEPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">get_block_root</span><span class="p">(</span><span class="nv">PrevEPOCH</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">setBitAt</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">get_attesting_balance</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">PrevEPOCH</span><span class="p">))</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_total_active_balance</span><span class="p">()</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateJustificationPrev</span><span class="p">(</span><span class="nv">PrevEPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nv">owise</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateJustificationCurr&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateJustificationCurr</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">get_block_root</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">setBitAt</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">get_attesting_balance</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">))</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_total_active_balance</span><span class="p">()</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateJustificationCurr</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">get_attesting_balance</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">CurrEPOCH</span><span class="p">))</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_total_active_balance</span><span class="p">()</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateFinalization&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateFinalization</span><span class="p">(</span><span class="nv">OldPrevJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">OldCurrJustCP</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint1</span><span class="p">(</span><span class="nv">OldPrevJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint2</span><span class="p">(</span><span class="nv">OldPrevJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint3</span><span class="p">(</span><span class="nv">OldCurrJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint4</span><span class="p">(</span><span class="nv">OldCurrJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">Bits</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">justification</span><span class="err">-</span><span class="nv">bits</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// if all(bits[1:4]) and old_previous_justified_checkpoint.epoch + 3 == current_epoch:</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateFinalizedCheckpoint1&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint1</span><span class="p">(</span><span class="nv">OldPrevJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">FCP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">allOnes</span><span class="p">(</span><span class="nv">slice</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">OldPrevJustCP.epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">OldPrevJustCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">FCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// if all(bits[1:3]) and old_previous_justified_checkpoint.epoch + 2 == current_epoch:</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateFinalizedCheckpoint2&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint2</span><span class="p">(</span><span class="nv">OldPrevJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">FCP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">allOnes</span><span class="p">(</span><span class="nv">slice</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">OldPrevJustCP.epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">OldPrevJustCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">FCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// if all(bits[0:3]) and old_current_justified_checkpoint.epoch + 2 == current_epoch:</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateFinalizedCheckpoint3&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint3</span><span class="p">(</span><span class="nv">OldCurrJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">FCP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">allOnes</span><span class="p">(</span><span class="nv">slice</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">OldCurrJustCP.epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">OldCurrJustCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">FCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// if all(bits[0:2]) and old_current_justified_checkpoint.epoch + 1 == current_epoch:</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;updateFinalizedCheckpoint4&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Checkpoint</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">BitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateFinalizedCheckpoint4</span><span class="p">(</span><span class="nv">OldCurrJustCP</span><span class="p">,</span><span class="w"> </span><span class="nv">Bits</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">FCP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">allOnes</span><span class="p">(</span><span class="nv">slice</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">OldCurrJustCP.epoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">OldCurrJustCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">FCP</span><span class="w"></span>
<span class="w">                </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-base-reward">
<span id="get-base-reward"></span><h2><code class="docutils literal notranslate"><span class="pre">get_base_reward</span></code><a class="headerlink" href="#get-base-reward" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">effective_balance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">effective_balance</span>
    <span class="k">return</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">effective_balance</span> <span class="o">*</span> <span class="n">BASE_REWARD_FACTOR</span> <span class="o">//</span> <span class="n">integer_squareroot</span><span class="p">(</span><span class="n">total_balance</span><span class="p">)</span> <span class="o">//</span> <span class="n">BASE_REWARDS_PER_EPOCH</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_base_reward&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="nv">.effectiveBalance</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BASE_REWARD_FACTOR</span><span class="w"></span>
<span class="w">          </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">integer_squareroot</span><span class="p">(</span><span class="nv">get_total_active_balance</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BASE_REWARDS_PER_EPOCH</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="get-attestation-deltas">
<span id="get-attestation-deltas"></span><h2><code class="docutils literal notranslate"><span class="pre">get_attestation_deltas</span></code><a class="headerlink" href="#get-attestation-deltas" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_attestation_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="n">penalties</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="n">eligible_validator_indices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">slashed</span> <span class="ow">and</span> <span class="n">previous_epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">withdrawable_epoch</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Micro-incentives for matching FFG source, FFG target, and head</span>
    <span class="n">matching_source_attestations</span> <span class="o">=</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="n">matching_head_attestations</span> <span class="o">=</span> <span class="n">get_matching_head_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attestations</span> <span class="ow">in</span> <span class="p">(</span><span class="n">matching_source_attestations</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">,</span> <span class="n">matching_head_attestations</span><span class="p">):</span>
        <span class="n">unslashed_attesting_indices</span> <span class="o">=</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">)</span>
        <span class="n">attesting_balance</span> <span class="o">=</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">unslashed_attesting_indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">eligible_validator_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">unslashed_attesting_indices</span><span class="p">:</span>
                <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">attesting_balance</span> <span class="o">//</span> <span class="n">total_balance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="c1"># Proposer and inclusion delay micro-rewards</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_source_attestations</span><span class="p">):</span>
        <span class="n">attestation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
            <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">matching_source_attestations</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">inclusion_delay</span><span class="p">)</span>
        <span class="n">proposer_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">PROPOSER_REWARD_QUOTIENT</span><span class="p">)</span>
        <span class="n">rewards</span><span class="p">[</span><span class="n">attestation</span><span class="o">.</span><span class="n">proposer_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">proposer_reward</span>
        <span class="n">max_attester_reward</span> <span class="o">=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="n">proposer_reward</span>
        <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span>
            <span class="n">max_attester_reward</span> <span class="o">//</span> <span class="n">attestation</span><span class="o">.</span><span class="n">inclusion_delay</span>
        <span class="p">)</span>

    <span class="c1"># Inactivity penalty</span>
    <span class="n">finality_delay</span> <span class="o">=</span> <span class="n">previous_epoch</span> <span class="o">-</span> <span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span><span class="o">.</span><span class="n">epoch</span>
    <span class="k">if</span> <span class="n">finality_delay</span> <span class="o">&gt;</span> <span class="n">MIN_EPOCHS_TO_INACTIVITY_PENALTY</span><span class="p">:</span>
        <span class="n">matching_target_attesting_indices</span> <span class="o">=</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">eligible_validator_indices</span><span class="p">:</span>
            <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">BASE_REWARDS_PER_EPOCH</span> <span class="o">*</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_target_attesting_indices</span><span class="p">:</span>
                <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">*</span> <span class="n">finality_delay</span> <span class="o">//</span> <span class="n">INACTIVITY_PENALTY_QUOTIENT</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;get_attestation_deltas&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">get_attestation_deltas</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">MicroIncentives</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#mapMapPair</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="nv">delayMicroRewards</span><span class="p">(</span><span class="nv">MicroIncentives.map1</span><span class="p">),</span><span class="w">  </span><span class="c1">// Rewards</span>
<span class="w">            </span><span class="nv">inactivityPenalty</span><span class="p">(</span><span class="nv">MicroIncentives.map2</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">// Penalties</span>
<span class="w">          </span><span class="p">)(</span><span class="w"> </span><span class="nv">microIncentives</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="c1"># Micro-incentives for matching FFG source, FFG target, and head</span>
    <span class="n">matching_source_attestations</span> <span class="o">=</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="n">matching_head_attestations</span> <span class="o">=</span> <span class="n">get_matching_head_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attestations</span> <span class="ow">in</span> <span class="p">(</span><span class="n">matching_source_attestations</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">,</span> <span class="n">matching_head_attestations</span><span class="p">):</span>
        <span class="n">unslashed_attesting_indices</span> <span class="o">=</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">)</span>
        <span class="n">attesting_balance</span> <span class="o">=</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">unslashed_attesting_indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">eligible_validator_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">unslashed_attesting_indices</span><span class="p">:</span>
                <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">attesting_balance</span> <span class="o">//</span> <span class="n">total_balance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">microIncentives</span><span class="p">()</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">microIncentives</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_active_balance</span><span class="p">(),</span><span class="w"></span>
<span class="w">           </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_head_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_head_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()))),</span><span class="w"></span>
<span class="w">           </span><span class="nv">microIncentivesAfterTargetAtt</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">microIncentivesAfterTargetAtt</span><span class="p">()</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">microIncentivesAfterTargetAtt</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_active_balance</span><span class="p">(),</span><span class="w"></span>
<span class="w">           </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()))),</span><span class="w"></span>
<span class="w">           </span><span class="nv">microIncentivesAfterSourceAtt</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">microIncentivesAfterSourceAtt</span><span class="p">()</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">microIncentivesAfterSourceAtt</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_active_balance</span><span class="p">(),</span><span class="w"></span>
<span class="w">           </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())),</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_total_balance</span><span class="p">(</span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()))),</span><span class="w"></span>
<span class="w">           </span><span class="nv">#mapMapPair</span><span class="p">(</span><span class="w"> </span><span class="nv">initMapOfSize</span><span class="p">(</span><span class="nv">numOfValidators</span><span class="p">()),</span><span class="w"> </span><span class="nv">initMapOfSize</span><span class="p">(</span><span class="nv">numOfValidators</span><span class="p">()))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="w"> </span><span class="nv">totalBalance</span><span class="p">:</span><span class="w">               </span><span class="nv">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">unslashedAttestingIndices</span><span class="p">:</span><span class="w">  </span><span class="nv">IntList</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">unslashedAttestingIndices</span><span class="p">:</span><span class="w">  </span><span class="nv">IntList</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">attestingBalance</span><span class="p">:</span><span class="w">           </span><span class="nv">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                          </span><span class="nv">rewardsAndPenalties</span><span class="p">:</span><span class="w">        </span><span class="nv">MapMapPair</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="nv">TotalBalance</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="nv">UnslashedIndices</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="nv">AttestingBalance</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="nv">#mapMapPair</span><span class="p">(</span><span class="nv">Rewards</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">contains</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">UnslashedIndices</span><span class="p">)</span><span class="w"></span>
<span class="w">                                              </span><span class="nv">#then</span><span class="w"> </span><span class="nv">Rewards</span><span class="p">[</span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">({</span><span class="nv">Rewards</span><span class="p">[</span><span class="nv">I</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                                                                  </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">AttestingBalance</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">TotalBalance</span><span class="p">)]</span><span class="w"></span>
<span class="w">                                              </span><span class="nv">#else</span><span class="w"> </span><span class="nv">Rewards</span><span class="w"></span>
<span class="w">                                              </span><span class="nv">#fi</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">Penalties</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">contains</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">UnslashedIndices</span><span class="p">)</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">#then</span><span class="w"> </span><span class="nv">Penalties</span><span class="p">[</span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">({</span><span class="nv">Penalties</span><span class="p">[</span><span class="nv">I</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">I</span><span class="p">))]</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">#else</span><span class="w"> </span><span class="nv">Penalties</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">#fi</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverEligibleValidatorIndices</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">RewardsPenalties</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">RewardsPenalties</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Second step in computing rewards</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">delayMicroRewards</span><span class="p">(</span><span class="nv">Map</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">delayMicroRewards</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">loopOverUnslashedAttestingIndices</span><span class="p">(</span><span class="w"></span>
<span class="w">           </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())),</span><span class="w"></span>
<span class="w">           </span><span class="nv">Rewards</span><span class="w"></span>
<span class="w">         </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">loopOverUnslashedAttestingIndices</span><span class="p">(</span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Map</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverUnslashedAttestingIndices</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">Rewards</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">updateMinDelayAttReward</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">))[</span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">({(</span><span class="nv">updateMinDelayAttReward</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">))[</span><span class="nv">I</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"></span>
<span class="w">                                  </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">computeMaxAttReward</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">computeProposerReward</span><span class="p">(</span><span class="nv">I</span><span class="p">))</span><span class="w"></span>
<span class="w">                                              </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">findMinDelayAttestation</span><span class="p">(</span><span class="w"></span>
<span class="w">                                                     </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                                                   </span><span class="p">)</span><span class="nv">.inclusionDelay</span><span class="w"></span>
<span class="w">                                        </span><span class="p">))</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">       </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverUnslashedAttestingIndices</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Rewards</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Rewards</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">updateMinDelayAttReward</span><span class="p">(</span><span class="nv">Map</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">updateMinDelayAttReward</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">          </span><span class="nv">updateAttProposerReward</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="nv">Rewards</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nv">findMinDelayAttestation</span><span class="p">(</span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">get_matching_source_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"> </span><span class="nv">I</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="nv">computeProposerReward</span><span class="p">(</span><span class="nv">I</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">// rewards[attestation.proposer_index] += proposer_reward</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">updateAttProposerReward</span><span class="p">(</span><span class="nv">Map</span><span class="w"> </span><span class="cm">/*Rewards*/</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingAttestation</span><span class="w"> </span><span class="cm">/*attestation*/</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*proposer_reward*/</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">updateAttProposerReward</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">,</span><span class="w"> </span><span class="nv">Attestation</span><span class="p">,</span><span class="w"> </span><span class="nv">PropReward</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Rewards</span><span class="p">[</span><span class="nv">Attestation.proposerIndex</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">{</span><span class="nv">Rewards</span><span class="p">[</span><span class="nv">Attestation.proposerIndex</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">PropReward</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="c1">// max_attester_reward = get_base_reward(state, index) - proposer_reward</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeMaxAttReward</span><span class="p">(</span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*Proposer index*/</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*proposer reward*/</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeMaxAttReward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">REWARD</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">REWARD</span><span class="w"></span>

<span class="w">  </span><span class="c1">// proposer_reward = Gwei(get_base_reward(state, index) // PROPOSER_REWARD_QUOTIENT)</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeProposerReward</span><span class="p">(</span><span class="nv">Int</span><span class="w"> </span><span class="cm">/*proposer index*/</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">computeProposerReward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">PROPOSER_REWARD_QUOTIENT</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
  <span class="n">attestation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
              <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">matching_source_attestations</span>
              <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">)</span>
          <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">inclusion_delay</span><span class="p">)</span>
  
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestationList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">contains</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">get_attesting_indices</span><span class="p">(</span><span class="nv">PA.data</span><span class="p">,</span><span class="w"> </span><span class="nv">PA.aggregationBits</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="nv">#then</span><span class="w"> </span><span class="nv">PA</span><span class="w"> </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="nv">#else</span><span class="w"> </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">filterAttForIndex</span><span class="p">(</span><span class="nv">.PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.PendingAttestationList</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestation</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">findMinDelayAttestation</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">findMinDelayAttestation</span><span class="p">(</span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">findMinDelayAttestationAux</span><span class="p">(</span><span class="nv">PAL</span><span class="p">,</span><span class="w"> </span><span class="nv">PA</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">PendingAttestation</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">findMinDelayAttestationAux</span><span class="p">(</span><span class="nv">PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingAttestation</span><span class="w"> </span><span class="cm">/*min delay attestation*/</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">findMinDelayAttestationAux</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="nv">PA</span><span class="w"> </span><span class="nv">PAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PAL</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">MinDelayPA</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">PA.inclusionDelay</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MinDelayPA.inclusionDelay</span><span class="w"></span>
<span class="w">                       </span><span class="nv">#then</span><span class="w"> </span><span class="nv">PA</span><span class="w"></span>
<span class="w">                       </span><span class="nv">#else</span><span class="w"> </span><span class="nv">MinDelayPA</span><span class="w"></span>
<span class="w">                       </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">findMinDelayAttestationAux</span><span class="p">(</span><span class="nv">.PendingAttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">MinDelayPA</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">MinDelayPA</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Second step in computing penalties</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">inactivityPenalty</span><span class="p">(</span><span class="nv">Map</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">inactivityPenalty</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">#if</span><span class="w"> </span><span class="nv">computeFinalityDelay</span><span class="p">()</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_EPOCHS_TO_INACTIVITY_PENALTY</span><span class="w"></span>
<span class="w">         </span><span class="nv">#then</span><span class="w"> </span><span class="nv">inactivityPenaltyAux</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="nv">#else</span><span class="w"> </span><span class="nv">Penalties</span><span class="w"></span>
<span class="w">         </span><span class="nv">#fi</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">inactivityPenaltyAux</span><span class="p">(</span><span class="nv">Map</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">inactivityPenaltyAux</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">loopOverEligibleValsForPen</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="nv">get_unslashed_attesting_indices</span><span class="p">(</span><span class="nv">get_matching_target_attestations</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())),</span><span class="w"></span>
<span class="w">            </span><span class="nv">Penalties</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">loopOverEligibleValsForPen</span><span class="p">(</span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">Map</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverEligibleValsForPen</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="nv">I</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">UnslashedIndices</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nv">Penalties</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">contains</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">UnslashedIndices</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="nv">#then</span><span class="w"> </span><span class="p">(</span><span class="nv">updateBasePenalties</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">))[</span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">{(</span><span class="nv">updateBasePenalties</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">))[</span><span class="nv">I</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"></span>
<span class="w">                                </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.effectiveBalance</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">computeFinalityDelay</span><span class="p">()</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">INACTIVITY_PENALTY_QUOTIENT</span><span class="p">)]</span><span class="w"></span>
<span class="w">                        </span><span class="nv">#else</span><span class="w"> </span><span class="nv">updateBasePenalties</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="nv">#fi</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">loopOverEligibleValsForPen</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">Penalties</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Penalties</span><span class="w"></span>

<span class="w">  </span><span class="c1">// finality_delay = previous_epoch - state.finalized_checkpoint.epoch</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">computeFinalityDelay</span><span class="p">()</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">computeFinalityDelay</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">get_previous_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">FCP.epoch</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">FCP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// penalties[index] += Gwei(BASE_REWARDS_PER_EPOCH * get_base_reward(state, index))</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">updateBasePenalties</span><span class="p">(</span><span class="nv">Map</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">updateBasePenalties</span><span class="p">(</span><span class="nv">Penalties</span><span class="p">,</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">Penalties</span><span class="p">[</span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;-</span><span class="w"> </span><span class="p">{</span><span class="nv">Penalties</span><span class="p">[</span><span class="nv">INDEX</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="p">(</span><span class="nv">BASE_REWARDS_PER_EPOCH</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_base_reward</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">))]</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">numOfValidators</span><span class="p">()</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">numOfValidators</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">size</span><span class="p">(</span><span class="nv">ValMap</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">ValMap</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getEligibleValidatorIndices</span><span class="p">(</span><span class="nv">PrevEP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">PrevEP</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">numOfValidators</span><span class="p">(),</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">PrevEP</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#fun</span><span class="p">(</span><span class="nv">VAL</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="nv">VAL</span><span class="p">,</span><span class="w"> </span><span class="nv">PrevEP</span><span class="p">)</span><span class="w"> </span><span class="nv">orBool</span><span class="w"> </span><span class="p">(</span><span class="nv">VAL.slashed</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">PrevEP</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">VAL.withdrawableEpoch</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="nv">#then</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">PrevEP</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">I</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="nv">#else</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">PrevEP</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">              </span><span class="p">)(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getEligibleValidatorIndicesLoop</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-rewards-and-penalties">
<span id="process-rewards-and-penalties"></span><h2><code class="docutils literal notranslate"><span class="pre">process_rewards_and_penalties</span></code><a class="headerlink" href="#process-rewards-and-penalties" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_rewards_and_penalties</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">GENESIS_EPOCH</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span> <span class="o">=</span> <span class="n">get_attestation_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">)):</span>
        <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_rewards_and_penalties&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_rewards_and_penalties</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_rewards_and_penalties</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">GENESIS_EPOCH</span><span class="w"></span>
<span class="w">          </span><span class="nv">#then</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">          </span><span class="nv">#else</span><span class="w"> </span><span class="nv">processRewardsAndPenaltiesLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="nv">numOfValidators</span><span class="p">(),</span><span class="w"></span>
<span class="w">                  </span><span class="nv">get_attestation_deltas</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processRewardsAndPenaltiesLoop&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">i</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">n</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">attestationDeltas</span><span class="p">:</span><span class="w"> </span><span class="nv">MapMapPair</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">increase_balance</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">Rewards</span><span class="p">[</span><span class="nv">INDEX</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">decrease_balance</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">Penalties</span><span class="p">[</span><span class="nv">INDEX</span><span class="p">]}:&gt;</span><span class="nv">Int</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">)</span><span class="w"> </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processRewardsAndPenaltiesLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="nv">N</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="nv">#mapMapPair</span><span class="p">(</span><span class="nv">Rewards</span><span class="p">,</span><span class="w"> </span><span class="nv">Penalties</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processRewardsAndPenaltiesLoop</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-registry-updates">
<span id="process-registry-updates"></span><h2><code class="docutils literal notranslate"><span class="pre">process_registry_updates</span></code><a class="headerlink" href="#process-registry-updates" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_registry_updates</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Process activation eligibility and ejections</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span>
            <span class="ow">and</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">==</span> <span class="n">MAX_EFFECTIVE_BALANCE</span>
        <span class="p">):</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="ow">and</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">&lt;=</span> <span class="n">EJECTION_BALANCE</span><span class="p">:</span>
            <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="c1"># Queue validators eligible for activation and not dequeued for activation prior to finalized epoch</span>
    <span class="n">activation_queue</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span>
        <span class="ow">and</span> <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">&gt;=</span> <span class="n">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">finalized_checkpoint</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span><span class="p">)</span>
    <span class="c1"># Dequeued validators for activation up to churn limit (without resetting activation epoch)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">activation_queue</span><span class="p">[:</span><span class="n">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">)]:</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span><span class="p">:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">=</span> <span class="n">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_registry_updates&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_registry_updates</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_registry_updates</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processRegistryUpdatesLoop1</span><span class="p">(</span><span class="nv">VALIDATORS</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">()</span><span class="w"></span>
<span class="w">         </span><span class="p">...</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">//we will process validators in any order, not strictly increasing index like in python</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processRegistryUpdatesLoop1&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="c1">//validators</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="nv">VAL</span><span class="p">,</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">                      </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">VAL.effectiveBalance</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EJECTION_BALANCE</span><span class="w"></span>
<span class="w">                    </span><span class="nv">#then</span><span class="w"> </span><span class="nv">initiate_validator_exit</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="nv">#else</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">                 </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">           </span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processRegistryUpdatesLoop1</span><span class="p">(</span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">ActEligibilityEpoch</span><span class="w"></span>
<span class="w">          </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">ActEligibilityEpoch</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>
<span class="w">                 </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">VAL.effectiveBalance</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="w"></span>
<span class="w">                </span><span class="nv">#then</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="nv">#else</span><span class="w"> </span><span class="nv">ActEligibilityEpoch</span><span class="w"></span>
<span class="w">             </span><span class="nv">#fi</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="nv">#as</span><span class="w"> </span><span class="nv">VAL</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processRegistryUpdatesLoop1</span><span class="p">(</span><span class="nv">.Map</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">()</span><span class="w"></span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="w"> </span><span class="nv">activationQueue</span><span class="p">:</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">churnLimit</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">//must be done here instead of main rule, basause it needs state updated by Loop1</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nv">sortActivationQueue</span><span class="p">(</span><span class="nv">getActivationQueueUnsorted</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">)),</span><span class="w"></span>
<span class="w">          </span><span class="nv">get_validator_churn_limit</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">...</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">:</span><span class="nv">Int</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nv">ActEpoch</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">compute_activation_exit_epoch</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()),</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">...</span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">             </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">ActEpoch</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">:</span><span class="nv">Int</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">             </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="nv">.activationEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processActivationQueue</span><span class="p">(</span><span class="w">       </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
  <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validator_registry</span><span class="p">)</span> <span class="k">if</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span> <span class="ow">and</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">&gt;=</span> <span class="n">get_delayed_activation_exit_epoch</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">finalized_epoch</span><span class="p">)</span> 
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getActivationQueueUnsorted</span><span class="p">(</span><span class="nv">i</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">validators</span><span class="p">:</span><span class="w"> </span><span class="nv">Map</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">:</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">getActivationQueueUnsorted</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w">  </span><span class="nv">IL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">FinalizedEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">RootHash</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.activationEligibilityEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>
<span class="w">         </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">VAL.activationEpoch</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">compute_activation_exit_epoch</span><span class="p">(</span><span class="nv">FinalizedEpoch</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">getActivationQueueUnsorted</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">),</span><span class="w">  </span><span class="nv">IL</span><span class="w"> </span><span class="cm">/*unchanged*/</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">#Checkpoint</span><span class="p">(</span><span class="nv">FinalizedEpoch</span><span class="p">,</span><span class="w"> </span><span class="nv">RootHash</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">finalized</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">VAL.activationEligibilityEpoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>
<span class="w">                   </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">VAL.activationEpoch</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">compute_activation_exit_epoch</span><span class="p">(</span><span class="nv">FinalizedEpoch</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getActivationQueueUnsorted</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">.Map</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">activation_queue</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span> <span class="n">index</span> <span class="k">for</span> <span class="o">...</span>
    <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">validator_registry</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">activation_eligibility_epoch</span><span class="p">)</span>
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">sortActivationQueue</span><span class="p">(</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">sortActivationQueue</span><span class="p">(</span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="nv">listExcept</span><span class="p">(</span><span class="nv">IL</span><span class="p">,</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="nv">IL</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">.IntList</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">sortActivationQueue</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.IntList</span><span class="w"></span>

<span class="w">  </span><span class="c1">// min of index: state.validator_registry[index].activation_eligibility_epoch)</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">)</span><span class="w">      </span><span class="p">[</span><span class="nv">function</span><span class="p">,</span><span class="w"> </span><span class="nv">klabel</span><span class="p">(</span><span class="nv">indexForMinEligEpoch</span><span class="p">)]</span><span class="w"></span>
<span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">,</span><span class="w"> </span><span class="nv">klabel</span><span class="p">(</span><span class="nv">indexForMinEligEpoch2</span><span class="p">)]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="nv">I</span><span class="p">:</span><span class="nv">Int</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="w"> </span><span class="nv">MIN</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">MIN</span><span class="p">)</span><span class="nv">.activationEligibilityEpoch</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.activationEligibilityEpoch</span><span class="w"></span>
<span class="w">                                      </span><span class="nv">#then</span><span class="w"> </span><span class="nv">MIN</span><span class="w"> </span><span class="nv">#else</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">#fi</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="p">(</span><span class="nv">I</span><span class="p">:</span><span class="nv">Int</span><span class="w"> </span><span class="nv">IL</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">IL</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">indexForMinEligEpoch</span><span class="p">(</span><span class="nv">MIN</span><span class="p">,</span><span class="w"> </span><span class="nv">.IntList</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">MIN</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-slashings">
<span id="process-slashings"></span><h2><code class="docutils literal notranslate"><span class="pre">process_slashings</span></code><a class="headerlink" href="#process-slashings" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_slashings</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="n">slashed</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">validator</span><span class="o">.</span><span class="n">withdrawable_epoch</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span>  <span class="c1"># Factored out from penalty numerator to avoid uint64 overflow</span>
            <span class="n">penalty_numerator</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">increment</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">slashings</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">total_balance</span><span class="p">)</span>
            <span class="n">penalty</span> <span class="o">=</span> <span class="n">penalty_numerator</span> <span class="o">//</span> <span class="n">total_balance</span> <span class="o">*</span> <span class="n">increment</span>
            <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">penalty</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_slashings&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_slashings</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_slashings</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="w">           </span><span class="nv">processSlashingsLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">             </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="nv">numOfValidators</span><span class="p">(),</span><span class="w"></span>
<span class="w">             </span><span class="nv">get_current_epoch</span><span class="p">(),</span><span class="w"></span>
<span class="w">             </span><span class="nv">get_total_active_balance</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processSlashingsLoop&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">i</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">nrValidators</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">decrease_balance</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.effectiveBalance</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">sumSlashings</span><span class="p">()</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="nv">TotalBalance</span><span class="p">))</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">TotalBalance</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processSlashingsLoop</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">EP</span><span class="p">,</span><span class="w"> </span><span class="nv">TotalBalance</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.slashed</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">EP</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.withdrawableEpoch</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processSlashingsLoop</span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">EP</span><span class="p">,</span><span class="w"> </span><span class="nv">TotalBalance</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.slashed</span><span class="w"> </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">EP</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span><span class="nv">.withdrawableEpoch</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processSlashingsLoop</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">sumSlashings</span><span class="p">()</span><span class="w">                                       </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">sumSlashings</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">sumMapIntValues</span><span class="p">(</span><span class="nv">SLASHINGS</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;slashings&gt;</span><span class="w"> </span><span class="nv">SLASHINGS</span><span class="w"> </span><span class="nt">&lt;/slashings&gt;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-final-updates">
<span id="process-final-updates"></span><h2><code class="docutils literal notranslate"><span class="pre">process_final_updates</span></code><a class="headerlink" href="#process-final-updates" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_final_updates</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">next_epoch</span> <span class="o">=</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">current_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Reset eth1 data votes</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SLOTS_PER_ETH1_VOTING_PERIOD</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">eth1_data_votes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Update effective balances with hysteresis</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">HALF_INCREMENT</span> <span class="o">=</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="ow">or</span> <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HALF_INCREMENT</span> <span class="o">&lt;</span> <span class="n">balance</span><span class="p">:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">balance</span> <span class="o">-</span> <span class="n">balance</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>
    <span class="c1"># Reset slashings</span>
    <span class="n">state</span><span class="o">.</span><span class="n">slashings</span><span class="p">[</span><span class="n">next_epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Set randao mix</span>
    <span class="n">state</span><span class="o">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">next_epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">)</span>
    <span class="c1"># Set historical root accumulator</span>
    <span class="k">if</span> <span class="n">next_epoch</span> <span class="o">%</span> <span class="p">(</span><span class="n">SLOTS_PER_HISTORICAL_ROOT</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">historical_batch</span> <span class="o">=</span> <span class="n">HistoricalBatch</span><span class="p">(</span><span class="n">block_roots</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">block_roots</span><span class="p">,</span> <span class="n">state_roots</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">state_roots</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">historical_roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">historical_batch</span><span class="p">))</span>
    <span class="c1"># Rotate current/previous epoch attestations</span>
    <span class="n">state</span><span class="o">.</span><span class="n">previous_epoch_attestations</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_epoch_attestations</span>
    <span class="n">state</span><span class="o">.</span><span class="n">current_epoch_attestations</span> <span class="o">=</span> <span class="p">[]</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_final_updates&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_final_updates</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_final_updates</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">updateEffectiveBalances</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">numOfValidators</span><span class="p">(),</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// param: HALF_INCREMENT</span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">resetSlashings</span><span class="p">((</span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">)</span><span class="w">     </span><span class="c1">// param: (slashings index)</span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">setRandaoMix</span><span class="p">((</span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">)</span><span class="w">       </span><span class="c1">// param: (rnd mixes index)</span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">setHistoricalRootAccumulator</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">rotateEpochAttestations</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">E1DL</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="p">(</span><span class="nv">SLOT</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">SLOTS_PER_ETH1_VOTING_PERIOD</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">#then</span><span class="w"> </span><span class="nv">.Eth1DataList</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">#else</span><span class="w"> </span><span class="nv">E1DL</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">updateEffectiveBalances</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">i</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">nrValidators</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">increment</span><span class="p">:</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateEffectiveBalances</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">HALF_INCREMENT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="nv">EffBal</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;balances&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EffBal</span><span class="w"> </span><span class="nv">orBool</span><span class="w"> </span><span class="nv">EffBal</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">HALF_INCREMENT</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">updateEffectiveBalances</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">HALF_INCREMENT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">EffBal</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;balances&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">BAL</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">N</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">notBool</span><span class="p">(</span><span class="nv">BAL</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">EffBal</span><span class="w"> </span><span class="nv">orBool</span><span class="w"> </span><span class="nv">EffBal</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="nv">HALF_INCREMENT</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">BAL</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">updateEffectiveBalances</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;resetSlashings&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">resetSlashings</span><span class="p">(</span><span class="nv">SlashIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;slashings&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">SlashIndex</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/slashings&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;setRandaoMix&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">setRandaoMix</span><span class="p">(</span><span class="nv">RndMixIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">RMS</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">setBytesAt</span><span class="p">(</span><span class="nv">RMS</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="nv">RndMixIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="nv">get_randao_mix</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">                                    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;/</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">next_epoch</span> <span class="o">%</span> <span class="p">(</span><span class="n">SLOTS_PER_HISTORICAL_ROOT</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">historical_batch</span> <span class="o">=</span> <span class="n">HistoricalBatch</span><span class="p">(</span><span class="n">block_roots</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">block_roots</span><span class="p">,</span> <span class="n">state_roots</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">state_roots</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">historical_roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">historical_batch</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">setHistoricalRootAccumulator</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">setHistoricalRootAccumulator</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">historical</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nv">HL</span><span class="p">:</span><span class="nv">BytesList</span><span class="w"></span>
<span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="p">(</span><span class="nv">SLOTS_PER_HISTORICAL_ROOT</span><span class="w"> </span><span class="err">/</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">              </span><span class="nv">#then</span><span class="w"> </span><span class="nv">HL</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">#HistoricalBatch</span><span class="p">({</span><span class="nv">mapToList</span><span class="p">(</span><span class="nv">BlockRoots</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">.BytesList</span><span class="p">)}:&gt;</span><span class="nv">BytesList</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                  </span><span class="p">{</span><span class="nv">mapToList</span><span class="p">(</span><span class="nv">StateRoots</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">.BytesList</span><span class="p">)}:&gt;</span><span class="nv">BytesList</span><span class="w"> </span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="nv">#else</span><span class="w"> </span><span class="nv">HL</span><span class="w"></span>
<span class="w">            </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;/</span><span class="nv">historical</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">BlockRoots</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">block</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">StateRoots</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">state</span><span class="err">-</span><span class="nv">roots</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;rotateEpochAttestations&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">rotateEpochAttestations</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">PEAS</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">CEAS</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CEAS</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.PendingAttestationList</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// State transition function -- Block processing</span>
<span class="w">  </span><span class="c1">//====================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="process-block">
<span id="process-block"></span><h2><code class="docutils literal notranslate"><span class="pre">process_block</span></code><a class="headerlink" href="#process-block" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_block</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">BeaconBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">process_block_header</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">process_randao</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">process_eth1_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">process_operations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_block&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BeaconBlock</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_block</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_block_header</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_randao</span><span class="p">(</span><span class="nv">BLOCK.body</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_eth1_data</span><span class="p">(</span><span class="nv">BLOCK.body</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations</span><span class="p">(</span><span class="nv">BLOCK.body</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-block-header">
<span id="process-block-header"></span><h2><code class="docutils literal notranslate"><span class="pre">process_block_header</span></code><a class="headerlink" href="#process-block-header" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_block_header</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">BeaconBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Verify that the slots match</span>
    <span class="k">assert</span> <span class="n">block</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span>
    <span class="c1"># Verify that the parent matches</span>
    <span class="k">assert</span> <span class="n">block</span><span class="o">.</span><span class="n">parent_root</span> <span class="o">==</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="p">)</span>
    <span class="c1"># Save current block as the new latest block</span>
    <span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span> <span class="o">=</span> <span class="n">BeaconBlockHeader</span><span class="p">(</span>
        <span class="n">slot</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="n">parent_root</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">parent_root</span><span class="p">,</span>
        <span class="c1"># `state_root` is zeroed and overwritten in the next `process_slot` call</span>
        <span class="n">body_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
        <span class="c1"># `signature` is zeroed</span>
    <span class="p">)</span>
    <span class="c1"># Verify proposer is not slashed</span>
    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">proposer</span><span class="o">.</span><span class="n">slashed</span>
    <span class="c1"># Verify proposer signature</span>
    <span class="k">assert</span> <span class="n">bls_verify</span><span class="p">(</span><span class="n">proposer</span><span class="o">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">block</span><span class="p">),</span> <span class="n">block</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_block_header&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BeaconBlock</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w">           </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_block_header</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_block_header</span><span class="p">(</span><span class="nv">BLOCK</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">OldBlockHEADER</span><span class="w">  </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#BeaconBlockHeader</span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="nv">BLOCK._slot</span><span class="p">,</span><span class="w">                 </span><span class="c1">// block.slot</span>
<span class="w">                               </span><span class="nv">BLOCK.parentRoot</span><span class="p">,</span><span class="w">            </span><span class="c1">// block.parent_root</span>
<span class="w">                               </span><span class="nv">defaultHash</span><span class="p">(),</span><span class="w">               </span><span class="c1">// zeroed</span>
<span class="w">                               </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">BLOCK.body</span><span class="p">),</span><span class="w">  </span><span class="c1">// hash_tree_root(block.body)</span>
<span class="w">                               </span><span class="nv">defaultBLSSignature</span><span class="p">()</span><span class="w">  </span><span class="p">)</span><span class="w">     </span><span class="c1">// zeroed</span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">latest</span><span class="err">-</span><span class="nv">block</span><span class="err">-</span><span class="nv">header</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">BLOCK._slot</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">BLOCK.parentRoot</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">signing_root</span><span class="p">(</span><span class="nv">OldBlockHEADER</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">get_beacon_proposer_index</span><span class="p">())</span><span class="nv">.slashed</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-randao">
<span id="process-randao"></span><h2><code class="docutils literal notranslate"><span class="pre">process_randao</span></code><a class="headerlink" href="#process-randao" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_randao</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># Verify RANDAO reveal</span>
    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="n">bls_verify</span><span class="p">(</span><span class="n">proposer</span><span class="o">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">epoch</span><span class="p">),</span> <span class="n">body</span><span class="o">.</span><span class="n">randao_reveal</span><span class="p">,</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_RANDAO</span><span class="p">))</span>
    <span class="c1"># Mix in RANDAO reveal</span>
    <span class="n">mix</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">randao_reveal</span><span class="p">))</span>
    <span class="n">state</span><span class="o">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_randao&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BeaconBlockBody</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_randao</span><span class="p">(</span><span class="nv">BlockBODY</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">         </span><span class="nv">RMS</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">setBytesAt</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="nv">RMS</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="nv">xor</span><span class="p">(</span><span class="nv">get_randao_mix</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()),</span><span class="w"> </span><span class="nv">hash</span><span class="p">(</span><span class="nv">BlockBODY.randaoReveal</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;/</span><span class="nv">randao</span><span class="err">-</span><span class="nv">mixes</span><span class="err">&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">process_eth1_data</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">eth1_data_votes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">eth1_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">eth1_data_votes</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">eth1_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">SLOTS_PER_ETH1_VOTING_PERIOD</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">eth1_data</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">eth1_data</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_eth1_data&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BeaconBlockBody</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_eth1_data</span><span class="p">(</span><span class="nv">BlockBODY</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">VOTES</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">VOTES</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="p">(</span><span class="nv">BlockBODY.eth1Data</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">BlockBODY.eth1Data</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">     </span><span class="nv">requires</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">VOTES</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="p">(</span><span class="nv">BlockBODY.eth1Data</span><span class="p">),</span><span class="w"> </span><span class="nv">BlockBODY.eth1Data</span><span class="p">)</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_ETH1_VOTING_PERIOD</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_eth1_data</span><span class="p">(</span><span class="nv">BlockBODY</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">VOTES</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">VOTES</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="p">(</span><span class="nv">BlockBODY.eth1Data</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">-</span><span class="nv">votes</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="c1">// state cell &lt;eth1-data&gt; unchanged</span>
<span class="w">     </span><span class="nv">requires</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">VOTES</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="p">(</span><span class="nv">BlockBODY.eth1Data</span><span class="p">),</span><span class="w"> </span><span class="nv">BlockBODY.eth1Data</span><span class="p">)</span><span class="w"> </span><span class="err">*</span><span class="nv">Int</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">&gt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_ETH1_VOTING_PERIOD</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Int</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">Eth1DataList</span><span class="p">,</span><span class="w"> </span><span class="nv">Eth1Data</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">E1D</span><span class="w"> </span><span class="nv">E1DL</span><span class="p">,</span><span class="w"> </span><span class="nv">E1D</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">#if</span><span class="w"> </span><span class="nv">E1D</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">E1D</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">                                    </span><span class="nv">#then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">E1DL</span><span class="p">,</span><span class="w"> </span><span class="nv">E1D</span><span class="err">&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                    </span><span class="nv">#else</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">E1DL</span><span class="p">,</span><span class="w"> </span><span class="nv">E1D</span><span class="err">&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                    </span><span class="nv">#fi</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">countEth1</span><span class="p">(</span><span class="nv">.Eth1DataList</span><span class="p">,</span><span class="w"> </span><span class="nv">E1D</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-operations">
<span id="process-operations"></span><h2><code class="docutils literal notranslate"><span class="pre">process_operations</span></code><a class="headerlink" href="#process-operations" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_operations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Verify that outstanding deposits are processed up to the maximum number of deposits</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">deposits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_DEPOSITS</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">eth1_data</span><span class="o">.</span><span class="n">deposit_count</span> <span class="o">-</span> <span class="n">state</span><span class="o">.</span><span class="n">eth1_deposit_index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">operations</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">proposer_slashings</span><span class="p">,</span> <span class="n">process_proposer_slashing</span><span class="p">),</span>
        <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">attester_slashings</span><span class="p">,</span> <span class="n">process_attester_slashing</span><span class="p">),</span>
        <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">attestations</span><span class="p">,</span> <span class="n">process_attestation</span><span class="p">),</span>
        <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">deposits</span><span class="p">,</span> <span class="n">process_deposit</span><span class="p">),</span>
        <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">voluntary_exits</span><span class="p">,</span> <span class="n">process_voluntary_exit</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="n">function</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_operations&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">BeaconBlockBody</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_operations</span><span class="p">(</span><span class="nv">BlockBODY</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">BlockBODY.proposerSlashings</span><span class="p">,</span><span class="w"> </span><span class="nv">BlockBODY.attesterSlashings</span><span class="p">,</span><span class="w">  </span><span class="nv">BlockBODY.attestations</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">BlockBODY.deposits</span><span class="p">,</span><span class="w">          </span><span class="nv">BlockBODY.voluntaryExits</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"> </span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">ETH1DATA</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">       </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">ETH1DINDEX</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">BlockBODY.deposits</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">MAX_DEPOSITS</span><span class="p">,</span><span class="w"> </span><span class="nv">ETH1DATA.deposit_count</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">ETH1DINDEX</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_operations_aux&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ProposerSlashingList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">AttesterSlashingList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">AttestationList</span><span class="w"></span>
<span class="w">                                            </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">DepositList</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">VoluntaryExitList</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_proposer_slashing</span><span class="p">(</span><span class="nv">PropSlashing</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">PropSlashing</span><span class="p">:</span><span class="nv">ProposerSlashing</span><span class="w"> </span><span class="nv">L</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">L</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_attester_slashing</span><span class="p">(</span><span class="nv">AttSlashing</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">.ProposerSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">AttSlashing</span><span class="p">:</span><span class="nv">AttesterSlashing</span><span class="w"> </span><span class="nv">L</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">L</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_attestation</span><span class="p">(</span><span class="nv">Att</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">.ProposerSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttesterSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">Att</span><span class="p">:</span><span class="nv">Attestation</span><span class="w"> </span><span class="nv">L</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">L</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_deposit</span><span class="p">(</span><span class="nv">DEP</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">.ProposerSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttesterSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">DEP</span><span class="p">:</span><span class="nv">Deposit</span><span class="w"> </span><span class="nv">L</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">L</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_voluntary_exit</span><span class="p">(</span><span class="nv">VolEX</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">.ProposerSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttesterSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">.DepositList</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="nv">VolEX</span><span class="p">:</span><span class="nv">VoluntaryExit</span><span class="w"> </span><span class="nv">L</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">L</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_operations_aux</span><span class="p">(</span><span class="nv">.ProposerSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttesterSlashingList</span><span class="p">,</span><span class="w"> </span><span class="nv">.AttestationList</span><span class="p">,</span><span class="w"> </span><span class="nv">.DepositList</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="nv">.VoluntaryExitList</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-proposer-slashing">
<span id="process-proposer-slashing"></span><h2><code class="docutils literal notranslate"><span class="pre">process_proposer_slashing</span></code><a class="headerlink" href="#process-proposer-slashing" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_proposer_slashing</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">proposer_slashing</span><span class="p">:</span> <span class="n">ProposerSlashing</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">proposer_slashing</span><span class="o">.</span><span class="n">proposer_index</span><span class="p">]</span>
    <span class="c1"># Verify slots match</span>
    <span class="k">assert</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_1</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_2</span><span class="o">.</span><span class="n">slot</span>
    <span class="c1"># But the headers are different</span>
    <span class="k">assert</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_1</span> <span class="o">!=</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_2</span>
    <span class="c1"># Check proposer is slashable</span>
    <span class="k">assert</span> <span class="n">is_slashable_validator</span><span class="p">(</span><span class="n">proposer</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="c1"># Signatures are valid</span>
    <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="p">(</span><span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_1</span><span class="p">,</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">header_2</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">,</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">slot</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">bls_verify</span><span class="p">(</span><span class="n">proposer</span><span class="o">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="n">header</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

    <span class="n">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">proposer_slashing</span><span class="o">.</span><span class="n">proposer_index</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_proposer_slashing&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">ProposerSlashing</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_proposer_slashing</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_proposer_slashing</span><span class="p">(</span><span class="nv">#ProposerSlashing</span><span class="p">(</span><span class="nv">ProposerIndex</span><span class="p">,</span><span class="w"> </span><span class="nv">HEAD1</span><span class="p">,</span><span class="w"> </span><span class="nv">HEAD2</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">slash_validator</span><span class="p">(</span><span class="nv">ProposerIndex</span><span class="p">,</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">HEAD1._slot</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="nv">HEAD2._slot</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">HEAD1</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">HEAD2</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">is_slashable_validator</span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">ProposerIndex</span><span class="p">),</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-attester-slashing">
<span id="process-attester-slashing"></span><h2><code class="docutils literal notranslate"><span class="pre">process_attester_slashing</span></code><a class="headerlink" href="#process-attester-slashing" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_attester_slashing</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attester_slashing</span><span class="p">:</span> <span class="n">AttesterSlashing</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">attestation_1</span> <span class="o">=</span> <span class="n">attester_slashing</span><span class="o">.</span><span class="n">attestation_1</span>
    <span class="n">attestation_2</span> <span class="o">=</span> <span class="n">attester_slashing</span><span class="o">.</span><span class="n">attestation_2</span>
    <span class="k">assert</span> <span class="n">is_slashable_attestation_data</span><span class="p">(</span><span class="n">attestation_1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attestation_2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation_1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation_2</span><span class="p">)</span>

    <span class="n">slashed_any</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attestation_1</span><span class="o">.</span><span class="n">attesting_indices</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">attestation_2</span><span class="o">.</span><span class="n">attesting_indices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">is_slashable_validator</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)):</span>
            <span class="n">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">slashed_any</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">slashed_any</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_attester_slashing&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">AttesterSlashing</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_attester_slashing</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_attester_slashing</span><span class="p">(</span><span class="nv">#AttesterSlashing</span><span class="p">(</span><span class="w"> </span><span class="nv">IAtt1</span><span class="p">,</span><span class="w"> </span><span class="nv">IAtt2</span><span class="w"> </span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">processAttesterSlashingLoop</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nv">sortIntList</span><span class="p">(</span><span class="nv">intersection</span><span class="p">(</span><span class="nv">IAtt1.attesting_indices</span><span class="p">,</span><span class="w"> </span><span class="nv">IAtt2.attesting_indices</span><span class="p">)),</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">is_slashable_attestation_data</span><span class="p">(</span><span class="nv">IAtt1.data</span><span class="p">,</span><span class="w"> </span><span class="nv">IAtt2.data</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">is_valid_indexed_attestation</span><span class="p">(</span><span class="nv">IAtt1</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">is_valid_indexed_attestation</span><span class="p">(</span><span class="nv">IAtt2</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;processAttesterSlashingLoop&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">IntList</span><span class="w"> </span><span class="err">/*</span><span class="nv">all</span><span class="w"> </span><span class="nv">attesting_indices</span><span class="w"></span>
</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">                                                 </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">Bool</span><span class="w"> </span><span class="cm">/*slashed_any*/</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">(</span><span class="err">.</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">slash_validator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="p">))</span><span class="w"></span>
<span class="w">       </span><span class="err">~&gt;</span><span class="w"> </span><span class="nv">processAttesterSlashingLoop</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="nv">ILIST</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">ILIST</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">is_slashable_validator</span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">),</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processAttesterSlashingLoop</span><span class="p">(</span><span class="nv">INDEX</span><span class="w"> </span><span class="nv">ILIST</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">ILIST</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">notBool</span><span class="w"> </span><span class="nv">is_slashable_validator</span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">),</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">processAttesterSlashingLoop</span><span class="p">(</span><span class="nv">.IntList</span><span class="p">,</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">  </span><span class="c1">//If 2nd arg is false, evaluation will get stuck. This corresponds to &quot;assert slashed_any&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="process-attestation">
<span id="process-attestation"></span><h2><code class="docutils literal notranslate"><span class="pre">process_attestation</span></code><a class="headerlink" href="#process-attestation" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestation</span><span class="p">:</span> <span class="n">Attestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">attestation</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">get_committee_count_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span> <span class="o">+</span> <span class="n">MIN_ATTESTATION_INCLUSION_DELAY</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span> <span class="o">+</span> <span class="n">SLOTS_PER_EPOCH</span>

    <span class="n">committee</span> <span class="o">=</span> <span class="n">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attestation</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span>

    <span class="n">pending_attestation</span> <span class="o">=</span> <span class="n">PendingAttestation</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">aggregation_bits</span><span class="o">=</span><span class="n">attestation</span><span class="o">.</span><span class="n">aggregation_bits</span><span class="p">,</span>
        <span class="n">inclusion_delay</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="n">proposer_index</span><span class="o">=</span><span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span>
        <span class="n">state</span><span class="o">.</span><span class="n">current_epoch_attestations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending_attestation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span>
        <span class="n">state</span><span class="o">.</span><span class="n">previous_epoch_attestations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending_attestation</span><span class="p">)</span>

    <span class="c1"># Check signature</span>
    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation</span><span class="p">))</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_attestation&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Attestation</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_attestation</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_attestation</span><span class="p">(</span><span class="w"> </span><span class="nv">ATT</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_attestation_if</span><span class="p">(</span><span class="nv">ATT</span><span class="p">,</span><span class="w"> </span><span class="nv">#PendingAttestation</span><span class="p">(</span><span class="nv">ATT.aggregation_bits</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                              </span><span class="nv">ATT._data</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                              </span><span class="nv">SLOT</span><span class="w"> </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">ATT._data._slot</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                              </span><span class="nv">get_beacon_proposer_index</span><span class="p">()))</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">       </span><span class="nt">&lt;slot&gt;</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="nt">&lt;/slot&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">ATT._data.index</span><span class="w"> </span><span class="err">&lt;</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_committee_count_at_slot</span><span class="p">(</span><span class="nv">ATT._data._slot</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="p">(</span><span class="nv">ATT._data.target.epoch</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="p">(</span><span class="nv">SetItem</span><span class="p">(</span><span class="nv">get_previous_epoch</span><span class="p">())</span><span class="w"> </span><span class="nv">SetItem</span><span class="p">(</span><span class="nv">get_current_epoch</span><span class="p">()))</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">ATT._data._slot</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">MIN_ATTESTATION_INCLUSION_DELAY</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">SLOT</span><span class="w"> </span><span class="err">&lt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">ATT._data._slot</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">SLOTS_PER_EPOCH</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">ATT.aggregation_bits</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">len</span><span class="p">(</span><span class="nv">get_beacon_committee</span><span class="p">(</span><span class="nv">ATT._data._slot</span><span class="p">,</span><span class="w"> </span><span class="nv">ATT._data.index</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c1">//logic starting from if statement inside `process_attestation`</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_attestation_if&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Attestation</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="nv">PendingAttestation</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>

<span class="w">  </span><span class="c1">//if case true</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_attestation_if</span><span class="p">(</span><span class="nv">ATT</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingATT</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_attestation_after_if</span><span class="p">(</span><span class="nv">ATT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">CurrEpochATTList</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">CurrEpochATTList</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">PendingATT</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">current</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">ATT._data.target.epoch</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="c1">//if condition</span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">ATT._data.source</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">CurrJustCHECKP</span><span class="w"></span>

<span class="w">  </span><span class="c1">//if case false</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_attestation_if</span><span class="p">(</span><span class="nv">ATT</span><span class="p">,</span><span class="w"> </span><span class="nv">PendingATT</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">process_attestation_after_if</span><span class="p">(</span><span class="nv">ATT</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">PrevJustCHECKP</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">justified</span><span class="err">-</span><span class="nv">checkpoint</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">PrevEpochATTList</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">PrevEpochATTList</span><span class="w"> </span><span class="err">+</span><span class="nv">append</span><span class="w"> </span><span class="nv">PendingATT</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">previous</span><span class="err">-</span><span class="nv">epoch</span><span class="err">-</span><span class="nv">attestations</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">ATT._data.target.epoch</span><span class="w"> </span><span class="p">=/=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="c1">//if condition</span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">ATT._data.source</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">PrevJustCHECKP</span><span class="w"></span>

<span class="w">  </span><span class="c1">//after if inside `process_attestation`</span>
<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_attestation_after_if&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Attestation</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_attestation_after_if</span><span class="p">(</span><span class="nv">ATT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">is_valid_indexed_attestation</span><span class="p">(</span><span class="nv">get_indexed_attestation</span><span class="p">(</span><span class="nv">ATT</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-deposit">
<span id="process-deposit"></span><h2><code class="docutils literal notranslate"><span class="pre">process_deposit</span></code><a class="headerlink" href="#process-deposit" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">Deposit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Verify the Merkle branch</span>
    <span class="k">assert</span> <span class="n">is_valid_merkle_branch</span><span class="p">(</span>
        <span class="n">leaf</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
        <span class="n">branch</span><span class="o">=</span><span class="n">deposit</span><span class="o">.</span><span class="n">proof</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Add 1 for the `List` length mix-in</span>
        <span class="n">index</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">eth1_deposit_index</span><span class="p">,</span>
        <span class="n">root</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">eth1_data</span><span class="o">.</span><span class="n">deposit_root</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Deposits must be processed in order</span>
    <span class="n">state</span><span class="o">.</span><span class="n">eth1_deposit_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">pubkey</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pubkey</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">amount</span>
    <span class="n">validator_pubkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">pubkey</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pubkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validator_pubkeys</span><span class="p">:</span>
        <span class="c1"># Verify the deposit signature (proof of possession) for new validators.</span>
        <span class="c1"># Note: The deposit contract does not check signatures.</span>
        <span class="c1"># Note: Deposits are valid across forks, thus the deposit domain is retrieved directly from `compute_domain`.</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">compute_domain</span><span class="p">(</span><span class="n">DOMAIN_DEPOSIT</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bls_verify</span><span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Add validator and balance entries</span>
        <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Validator</span><span class="p">(</span>
            <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">,</span>
            <span class="n">withdrawal_credentials</span><span class="o">=</span><span class="n">deposit</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">withdrawal_credentials</span><span class="p">,</span>
            <span class="n">activation_eligibility_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
            <span class="n">activation_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
            <span class="n">exit_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
            <span class="n">withdrawable_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
            <span class="n">effective_balance</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">amount</span> <span class="o">-</span> <span class="n">amount</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">),</span>
        <span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Increase balance by deposit amount</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">validator_pubkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pubkey</span><span class="p">))</span>
        <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_deposit&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">Deposit</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_deposit</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="c1">//case pubkey in validator_pubkeys</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_deposit</span><span class="p">(</span><span class="nv">DEP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">increase_balance</span><span class="p">(</span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">DEP.data.pubkey</span><span class="p">),</span><span class="w"> </span><span class="nv">DEP.data.amount</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">EDI</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">EDI</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">E1DATA</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">DEP.data.pubkey</span><span class="p">)</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">is_valid_merkle_branch</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">DEP.data</span><span class="p">),</span><span class="w"></span>
<span class="w">                 </span><span class="nv">DEP.proof</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">EDI</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">E1DATA.deposit_root</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">//case pubkey not in validator_pubkeys</span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nt">&lt;k&gt;</span><span class="w"> </span><span class="nv">process_deposit</span><span class="p">(</span><span class="nv">DEP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.K</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/k&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">EDI</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">EDI</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">deposit</span><span class="err">-</span><span class="nv">index</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="err">&lt;</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">E1DATA</span><span class="w"> </span><span class="err">&lt;/</span><span class="nv">eth1</span><span class="err">-</span><span class="nv">data</span><span class="err">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;validators&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nv">VALIDATORS</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nv">.Map</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">size</span><span class="p">(</span><span class="nv">VALIDATORS</span><span class="p">)</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">#Validator</span><span class="p">(</span><span class="nv">DEP.data.pubkey</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">DEP.data.withdrawal_credentials</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">minInt</span><span class="p">(</span><span class="nv">DEP.data.amount</span><span class="w"></span>
<span class="w">                                                  </span><span class="err">-</span><span class="nv">Int</span><span class="w"> </span><span class="nv">DEP.data.amount</span><span class="w"> </span><span class="nv">%Int</span><span class="w"> </span><span class="nv">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="nv">MAX_EFFECTIVE_BALANCE</span><span class="p">),</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;balances&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">size</span><span class="p">(</span><span class="nv">VALIDATORS</span><span class="p">)</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w">  </span><span class="nv">DEP.data.amount</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/balances&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">DEP.data.pubkey</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">is_valid_merkle_branch</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="nv">hash_tree_root</span><span class="p">(</span><span class="nv">DEP.data</span><span class="p">),</span><span class="w"></span>
<span class="w">                 </span><span class="nv">DEP.proof</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">EDI</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="nv">E1DATA.deposit_root</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="w"> </span><span class="nv">BLSPubkey</span><span class="w"> </span><span class="p">)</span><span class="w">                      </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="w"> </span><span class="nv">BLSPubkey</span><span class="p">,</span><span class="w"> </span><span class="nv">Map</span><span class="w"> </span><span class="cm">/*Validators*/</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">PUBKEY</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w">  </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">PUBKEY</span><span class="p">,</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="p">)</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">VALIDATORS</span><span class="w"> </span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">PUBKEY</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="p">:</span><span class="nv">Validator</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.Map</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.pubkey</span><span class="w"> </span><span class="p">=/=</span><span class="nv">K</span><span class="w"> </span><span class="nv">PUBKEY</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">PUBKEY</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">:</span><span class="nv">Map</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="p">:</span><span class="nv">Validator</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">I</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">VAL.pubkey</span><span class="w"> </span><span class="o">==</span><span class="nv">K</span><span class="w"> </span><span class="nv">PUBKEY</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">getValidatorIndexByPubkey</span><span class="p">(</span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">.Map</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">.ValidatorIndex</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="process-voluntary-exit">
<span id="process-voluntary-exit"></span><h2><code class="docutils literal notranslate"><span class="pre">process_voluntary_exit</span></code><a class="headerlink" href="#process-voluntary-exit" title="Permalink to this headline">¶</a></h2>
<p>Python reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_voluntary_exit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">exit</span><span class="p">:</span> <span class="n">VoluntaryExit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">exit</span><span class="o">.</span><span class="n">validator_index</span><span class="p">]</span>
    <span class="c1"># Verify the validator is active</span>
    <span class="k">assert</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="c1"># Verify the validator has not yet exited</span>
    <span class="k">assert</span> <span class="n">validator</span><span class="o">.</span><span class="n">exit_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span>
    <span class="c1"># Exits must specify an epoch requires they become valid; they are not valid before then</span>
    <span class="k">assert</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">exit</span><span class="o">.</span><span class="n">epoch</span>
    <span class="c1"># Verify the validator has been active long enough</span>
    <span class="k">assert</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">validator</span><span class="o">.</span><span class="n">activation_epoch</span> <span class="o">+</span> <span class="n">PERSISTENT_COMMITTEE_PERIOD</span>
    <span class="c1"># Verify signature</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_VOLUNTARY_EXIT</span><span class="p">,</span> <span class="n">exit</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bls_verify</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">(</span><span class="n">exit</span><span class="p">),</span> <span class="n">exit</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
    <span class="c1"># Initiate exit</span>
    <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">exit</span><span class="o">.</span><span class="n">validator_index</span><span class="p">)</span>

</pre></div>
</div>
<p>K semantics:</p>
<div class="highlight-k notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">KItem</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="s">&quot;process_voluntary_exit&quot;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">VoluntaryExit</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="p">[</span><span class="nv">klabel</span><span class="p">(</span><span class="nv">process_voluntary_exit</span><span class="p">),</span><span class="w"> </span><span class="nv">symbol</span><span class="p">]</span><span class="w"></span>

<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="nv">process_voluntary_exit</span><span class="p">(</span><span class="nv">#VoluntaryExit</span><span class="p">(</span><span class="nv">ExitEPOCH</span><span class="p">,</span><span class="w"> </span><span class="nv">ValINDEX</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">initiate_validator_exit</span><span class="p">(</span><span class="nv">ValINDEX</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">requires</span><span class="w"> </span><span class="nv">is_active_validator</span><span class="p">(</span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">ValINDEX</span><span class="p">),</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">())</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">ValINDEX</span><span class="p">)</span><span class="nv">.exitEpoch</span><span class="w"> </span><span class="o">==</span><span class="nv">Int</span><span class="w"> </span><span class="nv">FAR_FUTURE_EPOCH</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">ExitEPOCH</span><span class="w"></span>
<span class="w">     </span><span class="nv">andBool</span><span class="w"> </span><span class="nv">get_current_epoch</span><span class="p">()</span><span class="w"> </span><span class="err">&gt;</span><span class="o">=</span><span class="nv">Int</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">ValINDEX</span><span class="p">)</span><span class="nv">.activationEpoch</span><span class="w"> </span><span class="err">+</span><span class="nv">Int</span><span class="w"> </span><span class="nv">PERSISTENT_COMMITTEE_PERIOD</span><span class="w"></span>

<span class="w">  </span><span class="kd">syntax</span><span class="w"> </span><span class="nv">Validator</span><span class="w"> </span><span class="p">::=</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="w"> </span><span class="nv">ValidatorIndex</span><span class="w"> </span><span class="p">)</span><span class="w">                 </span><span class="p">[</span><span class="nv">function</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">rule</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="nv">getValidator</span><span class="p">(</span><span class="nv">INDEX</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="nt">&lt;validators&gt;</span><span class="w"> </span><span class="nv">INDEX</span><span class="w"> </span><span class="p">|-&gt;</span><span class="w"> </span><span class="nv">VAL</span><span class="w"> </span><span class="p">...</span><span class="nt">&lt;/validators&gt;</span><span class="w"></span>

<span class="nv">endmodule</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../hash-tree/" class="btn btn-neutral float-right" title="Hash Tree" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../README/" class="btn btn-neutral float-left" title="K Semantics of Eth2.0 Beacon Chain" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, The Beacon Chain Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>